<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.0"/>
    <title>pyCBEM.RGC_CBEM API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyCBEM.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyCBEM</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#getSimpleStimulusBasis">getSimpleStimulusBasis</a>
            </li>
            <li>
                    <a class="function" href="#getSimpleSpkHistBasis">getSimpleSpkHistBasis</a>
            </li>
            <li>
                    <a class="class" href="#CBEM_basic">CBEM_basic</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CBEM_basic.__init__">CBEM_basic</a>
                        </li>
                        <li>
                                <a class="variable" href="#CBEM_basic.B_cond">B_cond</a>
                        </li>
                        <li>
                                <a class="variable" href="#CBEM_basic.B_hspk">B_hspk</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.setObservations">setObservations</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getConductances">getConductances</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getVoltage">getVoltage</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.firingRateNonlinearity">firingRateNonlinearity</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getSpikeHistory">getSpikeHistory</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getSpikeRate">getSpikeRate</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getLogLike">getLogLike</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.randomizeParameters">randomizeParameters</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.vectorizeParameters">vectorizeParameters</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.devectorizeParameters">devectorizeParameters</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.setParametersFromVector">setParametersFromVector</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.vectorizedNegLogLike">vectorizedNegLogLike</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.vectorizedPenalizedNegLogLike">vectorizedPenalizedNegLogLike</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getConductanceFilter">getConductanceFilter</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.getSpikeHistoryFilter">getSpikeHistoryFilter</a>
                        </li>
                        <li>
                                <a class="function" href="#CBEM_basic.simulateSpikeTrains">simulateSpikeTrains</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pyCBEM.html">pyCBEM</a><wbr>.RGC_CBEM    </h1>

                        <div class="docstring"><p>Simple class to solve the Conductance-based encoding model for retinal ganglion cells in:
    K. W. Latimer,  F. Rieke, &amp; J. W. Pillow (2019). Inferring synaptic inputs from spikes with a conductance-based neural encoding model.eLife 8 (2019): e47012.</p>

<p>Requires Jax for computations.</p>

<p>Copyright (c) 2022 Kenneth Latimer</p>
</div>

                        <input id="RGC_CBEM-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="RGC_CBEM-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Simple class to solve the Conductance-based encoding model for retinal ganglion cells in:</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">    K. W. Latimer,  F. Rieke, &amp; J. W. Pillow (2019). Inferring synaptic inputs from spikes with a conductance-based neural encoding model.eLife 8 (2019): e47012.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">Requires Jax for computations.</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">Copyright (c) 2022 Kenneth Latimer</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span> <span class="nn">scipy</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">jax</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">pyCBEM</span> <span class="kn">import</span> <span class="n">utils</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="k">def</span> <span class="nf">getSimpleStimulusBasis</span><span class="p">(</span><span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    A simple default basis to use for stimulus-dependent conductance filters made with a modified cardinal spline.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    Args:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">      binSize_ms: time bin size in milliseconds</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    Returns:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">      A tuple (basis, time)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        basis: [BT_stim x P_stim] - Each column is a basis vector</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        time:  [BT_stim] - Time (in milliseconds) of the rows of the basis</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModifiedCardinalSpline</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="n">binSize_ms</span><span class="o">=</span><span class="n">binSize_ms</span><span class="p">,</span> <span class="n">zero_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_first</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="k">def</span> <span class="nf">getSimpleSpkHistBasis</span><span class="p">(</span><span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    A simple default basis to use for spike history filters made with a modified cardinal spline.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    Args:</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">      binSize_ms: time bin size in milliseconds</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    Returns:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">      A tuple (basis, time)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        basis: [BT_hspk x P_hspk] - Each column is a basis vector</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        time:  [BT_stim] - Time (in milliseconds) of the rows of the basis</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModifiedCardinalSpline</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="n">binSize_ms</span><span class="o">=</span><span class="n">binSize_ms</span><span class="p">,</span> <span class="n">zero_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_first</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="k">class</span> <span class="nc">CBEM_basic</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    A basic implementation of the Conductance-based encoding model.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    The model has three inputs: excitatory and inhibitory conductance (soft-rectified, affine function in the stimulus)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">                                a linear spike history (not conductance-based)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    The &#39;setObservations&#39; sets up the data: current stimulus and spike train.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">basis_conductance</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basis_hspk</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        Initialize simple CBEM with one excitatory and one inhibitory conductance which share input.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        </span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        Note: bases are orthogonalized before fitting. Filter parameters will be in terms of the orthogonalized basis.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        Args:</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">          binSize_ms:           time bin size in milliseconds</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">          basis_conductance:    [BT_stim x P_stim], if None then getSimpleStimulusBasis(binSize_ms) -</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">                                Each column is a basis function for the conductances (conductances share a basis).</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">                                The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">          basis_hspk:           [BT_hspk x P_hspk], if None then getSimpleSpkHistBasis(binSize_ms) -</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">                                Each column is a basis function for the spike history.</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">                                The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="c1"># discretization size</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span>    <span class="o">=</span> <span class="n">binSize_ms</span><span class="p">;</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bin size must be positive&quot;</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="c1"># setup bases for filters</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">basis_conductance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="n">basis_conductance</span><span class="p">,</span><span class="n">tts</span> <span class="o">=</span> <span class="n">getSimpleStimulusBasis</span><span class="p">(</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">basis_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="n">basis_hspk</span><span class="p">,</span><span class="n">tts</span> <span class="o">=</span> <span class="n">getSimpleSpkHistBasis</span><span class="p">(</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="k">assert</span> <span class="n">basis_conductance</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Basis cannot be more than 2 dimensions&quot;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="k">assert</span> <span class="n">basis_hspk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Basis cannot be more than 2 dimensions&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance_0</span> <span class="o">=</span> <span class="n">basis_conductance</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk_0</span>      <span class="o">=</span> <span class="n">basis_hspk</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">orth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance_0</span><span class="p">));</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span>        <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">orth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk_0</span> <span class="p">));</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="c1"># setup LIF parameters </span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">E_input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">]);</span> <span class="c1"># mV</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span> <span class="c1"># mV</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">g_l</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> 
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span><span class="p">;</span> <span class="c1"># initial voltage</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">53</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span> <span class="p">:</span> <span class="mf">1.67</span><span class="p">};</span> <span class="c1"># &quot;beta&quot; : 1.67 or could be 1/0.45?</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="c1"># no stimulus set yet - won&#39;t run model</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="c1"># Properties for the model parameters</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="nd">@property</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="k">def</span> <span class="nf">B_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="sd">&quot;&quot;&quot;jnp.ndarray: [(BT_stim + 1) x 2] - The conductance filters and baseline parameters.&quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>    <span class="nd">@B_cond</span><span class="o">.</span><span class="n">setter</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="k">def</span> <span class="nf">B_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="sd">&quot;&quot;&quot;Note: cannot change filter size&quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;Conductance filter is incorrect shape&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>    <span class="nd">@property</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">B_hspk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="sd">&quot;&quot;&quot;jnp.ndarray: [BT_hspk x 1] - The spike history filter parameters.&quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="nd">@B_hspk</span><span class="o">.</span><span class="n">setter</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="k">def</span> <span class="nf">B_hspk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="sd">&quot;&quot;&quot;Note: cannot change filter size&quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;Spike history filter is incorrect shape&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">setObservations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Stimulus</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">spkTimes_bins</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">window</span> <span class="p">:</span> <span class="nb">range</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        Initializes the stimulus and spike train observation for this neuron.</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        This assumes only one spike per bin is possible.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        Args:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">          Stimulus:         [T_stim x number of pixels] - Pixels are treated independently</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">          spkTimes_bins:    List of the spike times in bins.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">          window:           The window of stimulus and spikes to fit. This input allows you to cut out the first </span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">                            part of the given spike train to avoid edge effects for spike history or stimulus.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="c1"># get the conductance desgin matrix(same for both conductances)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">convolveStimulusWithBasis</span><span class="p">(</span><span class="n">Stimulus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="p">)[</span><span class="n">window</span><span class="p">,:]);</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="c1"># get spike history</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="n">X_l</span><span class="p">,</span> <span class="n">Y_0</span>      <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">convolveSpksWithBasis</span><span class="p">(</span><span class="n">spkTimes_bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="p">,</span> <span class="n">Stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span>    <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_l</span><span class="p">[</span><span class="n">window</span><span class="p">,:]);</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="c1"># get spike times within the current window</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span>              <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_0</span><span class="p">[</span><span class="n">window</span><span class="p">]);</span> <span class="c1"># vectorized spike times</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">spkTimes_bins</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span> 
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="c1"># setup empty parameters</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="c1">### functions for handling the voltage model</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">getConductances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">        Computes the conductances given the conductance filter parameters for the current stimulus.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">        The conductance nonlinearity is a soft-rectifier.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">        Args:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.get_B_cond() -</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">                        Parameters of the two conductance filters as weights on the basis functions. First column is excitatory, second inhibitory.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">                        The last entry is the basline term.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        </span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        Returns:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">          gs  [T_stim x 2] - first column is excitatory conductance, second inhibitory</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Stimulus not initialized!&quot;</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B_cond</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">),</span> <span class="s2">&quot;Conductance parameters not correct shape&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="o">@</span> <span class="n">B_cond</span><span class="p">);</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>    <span class="k">def</span> <span class="nf">getVoltage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">        Computes the voltage given the conductance parameters for the set stimulus.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        </span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">        Args:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">          B_cond:  [(P_stim + 1) x 2], if None then  self.get_B_cond() -</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">                        Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">                        The last entry is the basline term.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">                        </span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        Returns:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">          V [T_stim] - the solved voltage in millivolts</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConductances</span><span class="p">(</span><span class="n">B_cond</span><span class="p">);</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">)(</span><span class="n">gs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="k">def</span> <span class="nf">firingRateNonlinearity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V_tot</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        Computes the firing rate nonlinearity on the given total voltage.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        The nonlinearity is alpha * softplus((V_tot - mu)/beta)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        - self.frNonlinearity holds the parameters alpha, beta, and mu</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        Args:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">          V_tot:    [T] - The total voltage terms.</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">                    Total voltage is the membrane potential from the membrane potential equation plus spike history terms.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        Returns:              </span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">          spikeRate [T] - the firing rate for each term in V_tot</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">((</span><span class="n">V_tot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">])</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]);</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">getSpikeHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        Computes the spike history given the parameters for the set spike train. (A simple linear function)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        Args:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">                        </span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        Returns:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">          hspk  [T_stim] - the linear spike history</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B_hspk</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">),</span> <span class="s2">&quot;Linear parameters not correct shape&quot;</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span> <span class="o">@</span> <span class="n">B_hspk</span><span class="p">;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>    <span class="k">def</span> <span class="nf">getSpikeRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span>  <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span>  <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        Computes the spike rate at each time given the conductance and spike history parameters for the set stimulus &amp; spike history.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        Args:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then  self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">        Returns            </span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">          spikeRate [T_stim] - the firing rate in each bin in units of spikes/sec</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="n">V_tot</span>  <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">(</span><span class="n">B_cond</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpikeHistory</span><span class="p">(</span><span class="n">B_hspk</span><span class="p">);</span> <span class="c1"># add membrane voltage and spike history </span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">firingRateNonlinearity</span><span class="p">(</span><span class="n">V_tot</span><span class="p">);</span> <span class="c1"># pass through transfer function</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="c1">### log likelihood of spikes</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>    <span class="k">def</span> <span class="nf">getLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">        Computes the log likelihood at each time bin given the conductance and spike history parameters for the set stimulus &amp; spike history.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">        This function uses a truncated Poisson likelihood. That is, Poisson(0 | rate) for bins without a spike and</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">                                                                 (1-Poisson(0 | rate)) for bins with a spike.</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">        Args:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">                        </span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">        Returns:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">          ll_bins [T_stim] - the log likelihood of the observation (a spike or no spike) at each bin.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="n">ll_bins</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpikeRate</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">);</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="n">ll_bins</span> <span class="o">=</span> <span class="n">ll_bins</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ll_bins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span><span class="p">])));</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="k">return</span> <span class="n">ll_bins</span><span class="p">;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>    <span class="c1">### functions for handling parameters</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>    <span class="k">def</span> <span class="nf">randomizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset_term_mean</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">std_cond</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">std_lin</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        Sets the parameters of the model using i.i.d. normal draws.</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        All filter weights are drawn with mean 0.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        Args:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">          offset_term_mean: Mean of the baseline term of the conductances. This probably should be positive.</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">          std_cond:         Standard deviation of the conductance parameters.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">          std_lin:          Standard deviation of the spike history parameters.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">                        </span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        Returns:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">          A tuple (B_cond, B_hspk)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">            B_cond: [(P_stim + 1) x 2] - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            B_hspk:  [P_hspk x 1] - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std_cond</span><span class="p">);</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std_lin</span><span class="p">);</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">offset_term_mean</span><span class="p">);</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">);</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>    <span class="k">def</span> <span class="nf">vectorizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        Flatens the parameters into a vector for optimization.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">        Args:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.B_cond -</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">                    Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then self.B_hspk -</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">                    Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">                    The last entry is the basline term.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">                        </span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        Returns:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">          B [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">B_cond</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">B_hspk</span><span class="o">.</span><span class="n">flatten</span><span class="p">()));</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>    <span class="k">def</span> <span class="nf">devectorizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        Takens in a vector of the parameters and returns them in more convenient separate, matrix forms.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        Args:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">          B:  [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">        </span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">        Returns:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="sd">          A tuple (B_cond, B_hspk)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="sd">            B_cond: [(P_stim + 1) x 2] - </span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">                Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">            B_hspk:  [P_hspk x 1] - </span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">                Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">                The last entry is the basline term.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;B is incorrect size: must be a vector containing both conductance and linear terms&quot;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>  <span class="n">B</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">setParametersFromVector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">        Sets the current parameters from a vectorized form.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        Args:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">          B:    [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="c1"># Vectorized negative log likelihood functions for optimization</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="k">def</span> <span class="nf">vectorizedNegLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        Computes the negative log likelihood for the set stimulus and spike train.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">        Takes in the parameters in a vectorized form for use with optimizers.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        Args:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">          B:    [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">        Returns:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">          nll [1] - The total negative log likelihood for the setup stimulus.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogLike</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">());</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="k">def</span> <span class="nf">vectorizedPenalizedNegLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">conductance_penalty</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">        Computes the penalized negative log likelihood for the set stimulus and spike train.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        Takes in the parameters in a vectorized form for use with optimizers.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        The penalty terms are the weighted squared norms of the conductance filters.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        </span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        Args:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">          B: [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">                    This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">          conductance_penalty:  [2] -</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">                    The weights of the penalty on the squared norms of the filter weights.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">                    The first term is for the excitatory and the second for the inhibitory.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">                    The baseline conductance terms do not contribute to this penalty.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        Returns:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">          nll [1] - The total negative log likelihood for the setup stimulus plus the penalties.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogLike</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">());</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>            <span class="n">nll</span> <span class="o">+=</span> <span class="n">conductance_penalty</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">);</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="k">return</span> <span class="n">nll</span><span class="p">;</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="k">def</span> <span class="nf">getConductanceFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        Gets the full conductance filter (basis times weights) for one of the conductance filters.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        Args:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">          cc: Index of the conductance filter to return. 0 is excitatory, 1 is inhibitory.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        Returns:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">          k_stim [BT_stim x N_pixels] - The filter for each pixel.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span> <span class="o">@</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">cc</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span><span class="p">));</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>    <span class="k">def</span> <span class="nf">getSpikeHistoryFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        Gets the full spike history filter (basis times weights).</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        Returns:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">          h_spk [BT_hspk x 1] - The full spike history filter.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">;</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="c1"># simulate a set of spike trains given the currently set stimulus</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="k">def</span> <span class="nf">simulateSpikeTrains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y_init</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">N</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        Simulates a set of spike trains with the currently set stimulus. This can be really slow!</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        This function requires an initial set of spikes to avoid dealing with edge effects of the spike history filter.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Args:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">          Y_init:  [T_0 x (N or 1)] - A matrix of ones and zerosThe initial spike trains. T_0 should be less than T_stim</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">          N:       (positive integer) - The number of simulations: only use this if Y_init.shape[1] == 1 and you want more than one simulation.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">                                             If N &gt; 1 and Y_init.shape[1] == 1, it uses the same initial spike train for all simulations.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">                                                                 </span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        Returns:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">          sps [T_stim x N] - A matrix of spikes for each of the N simulations. Spikes are either 1 or 0.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="n">Y_init</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Invalid arguments for number of simulations&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># total simulation length</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="n">T_0</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># initial seed length</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">P_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="k">assert</span> <span class="n">T_0</span> <span class="o">&gt;</span> <span class="n">P_lin</span> <span class="ow">and</span> <span class="n">T_0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;initial spike train too short for bases&quot;</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="k">assert</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no simulations requested&quot;</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="c1"># sets up spikes</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="n">sps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="n">sps</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">at</span><span class="p">[:</span><span class="n">T_0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Y_init</span><span class="p">);</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="c1"># gets voltage (in this model, it&#39;s determined by the stimulus. Would need a more complex function for spike-dependent conductances)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">();</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="n">h_spk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSpikeHistoryFilter</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="c1"># random values for spike generation</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="n">rs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; simulations... (WARNING: This function can be painfully slow!)&quot;</span><span class="p">);</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_0 = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T_0</span><span class="p">));</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T_0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="k">if</span> <span class="n">tt</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tt = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; / &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="c1"># gets spike history &amp; adds to voltage</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="n">V_c</span> <span class="o">=</span> <span class="n">h_spk</span> <span class="o">@</span> <span class="n">sps</span><span class="p">[(</span><span class="n">tt</span><span class="o">-</span><span class="n">P_lin</span><span class="p">):</span><span class="n">tt</span><span class="p">,:];</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>            <span class="n">V_c</span> <span class="o">+=</span> <span class="n">V</span><span class="p">[</span><span class="n">tt</span><span class="p">];</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="c1"># gets spike probability</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="n">fr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">firingRateNonlinearity</span><span class="p">(</span><span class="n">V_c</span><span class="p">);</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="n">p_1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fr</span><span class="p">));</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="n">spiked</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="n">p_1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">();</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="c1"># generates spike</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="n">sps</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">spiked</span><span class="p">);</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">);</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">sps</span><span class="p">;</span>
</span></pre></div>


            </section>
                <section id="getSimpleStimulusBasis">
                            <input id="getSimpleStimulusBasis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getSimpleStimulusBasis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">binSize_ms</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="getSimpleStimulusBasis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#getSimpleStimulusBasis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="getSimpleStimulusBasis-21"><a href="#getSimpleStimulusBasis-21"><span class="linenos">21</span></a><span class="k">def</span> <span class="nf">getSimpleStimulusBasis</span><span class="p">(</span><span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="getSimpleStimulusBasis-22"><a href="#getSimpleStimulusBasis-22"><span class="linenos">22</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="getSimpleStimulusBasis-23"><a href="#getSimpleStimulusBasis-23"><span class="linenos">23</span></a><span class="sd">    A simple default basis to use for stimulus-dependent conductance filters made with a modified cardinal spline.</span>
</span><span id="getSimpleStimulusBasis-24"><a href="#getSimpleStimulusBasis-24"><span class="linenos">24</span></a>
</span><span id="getSimpleStimulusBasis-25"><a href="#getSimpleStimulusBasis-25"><span class="linenos">25</span></a><span class="sd">    Args:</span>
</span><span id="getSimpleStimulusBasis-26"><a href="#getSimpleStimulusBasis-26"><span class="linenos">26</span></a><span class="sd">      binSize_ms: time bin size in milliseconds</span>
</span><span id="getSimpleStimulusBasis-27"><a href="#getSimpleStimulusBasis-27"><span class="linenos">27</span></a>
</span><span id="getSimpleStimulusBasis-28"><a href="#getSimpleStimulusBasis-28"><span class="linenos">28</span></a><span class="sd">    Returns:</span>
</span><span id="getSimpleStimulusBasis-29"><a href="#getSimpleStimulusBasis-29"><span class="linenos">29</span></a><span class="sd">      A tuple (basis, time)</span>
</span><span id="getSimpleStimulusBasis-30"><a href="#getSimpleStimulusBasis-30"><span class="linenos">30</span></a>
</span><span id="getSimpleStimulusBasis-31"><a href="#getSimpleStimulusBasis-31"><span class="linenos">31</span></a><span class="sd">        basis: [BT_stim x P_stim] - Each column is a basis vector</span>
</span><span id="getSimpleStimulusBasis-32"><a href="#getSimpleStimulusBasis-32"><span class="linenos">32</span></a>
</span><span id="getSimpleStimulusBasis-33"><a href="#getSimpleStimulusBasis-33"><span class="linenos">33</span></a><span class="sd">        time:  [BT_stim] - Time (in milliseconds) of the rows of the basis</span>
</span><span id="getSimpleStimulusBasis-34"><a href="#getSimpleStimulusBasis-34"><span class="linenos">34</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="getSimpleStimulusBasis-35"><a href="#getSimpleStimulusBasis-35"><span class="linenos">35</span></a>    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModifiedCardinalSpline</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="n">binSize_ms</span><span class="o">=</span><span class="n">binSize_ms</span><span class="p">,</span> <span class="n">zero_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_first</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</span></pre></div>


            <div class="docstring"><p>A simple default basis to use for stimulus-dependent conductance filters made with a modified cardinal spline.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>binSize_ms:</strong>  time bin size in milliseconds</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A tuple (basis, time)</p>
  
  <p>basis: [BT_stim x P_stim] - Each column is a basis vector</p>
  
  <p>time:  [BT_stim] - Time (in milliseconds) of the rows of the basis</p>
</blockquote>
</div>


                </section>
                <section id="getSimpleSpkHistBasis">
                            <input id="getSimpleSpkHistBasis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getSimpleSpkHistBasis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">binSize_ms</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="getSimpleSpkHistBasis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#getSimpleSpkHistBasis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="getSimpleSpkHistBasis-37"><a href="#getSimpleSpkHistBasis-37"><span class="linenos">37</span></a><span class="k">def</span> <span class="nf">getSimpleSpkHistBasis</span><span class="p">(</span><span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="getSimpleSpkHistBasis-38"><a href="#getSimpleSpkHistBasis-38"><span class="linenos">38</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="getSimpleSpkHistBasis-39"><a href="#getSimpleSpkHistBasis-39"><span class="linenos">39</span></a><span class="sd">    A simple default basis to use for spike history filters made with a modified cardinal spline.</span>
</span><span id="getSimpleSpkHistBasis-40"><a href="#getSimpleSpkHistBasis-40"><span class="linenos">40</span></a>
</span><span id="getSimpleSpkHistBasis-41"><a href="#getSimpleSpkHistBasis-41"><span class="linenos">41</span></a><span class="sd">    Args:</span>
</span><span id="getSimpleSpkHistBasis-42"><a href="#getSimpleSpkHistBasis-42"><span class="linenos">42</span></a><span class="sd">      binSize_ms: time bin size in milliseconds</span>
</span><span id="getSimpleSpkHistBasis-43"><a href="#getSimpleSpkHistBasis-43"><span class="linenos">43</span></a>
</span><span id="getSimpleSpkHistBasis-44"><a href="#getSimpleSpkHistBasis-44"><span class="linenos">44</span></a><span class="sd">    Returns:</span>
</span><span id="getSimpleSpkHistBasis-45"><a href="#getSimpleSpkHistBasis-45"><span class="linenos">45</span></a><span class="sd">      A tuple (basis, time)</span>
</span><span id="getSimpleSpkHistBasis-46"><a href="#getSimpleSpkHistBasis-46"><span class="linenos">46</span></a>
</span><span id="getSimpleSpkHistBasis-47"><a href="#getSimpleSpkHistBasis-47"><span class="linenos">47</span></a><span class="sd">        basis: [BT_hspk x P_hspk] - Each column is a basis vector</span>
</span><span id="getSimpleSpkHistBasis-48"><a href="#getSimpleSpkHistBasis-48"><span class="linenos">48</span></a>
</span><span id="getSimpleSpkHistBasis-49"><a href="#getSimpleSpkHistBasis-49"><span class="linenos">49</span></a><span class="sd">        time:  [BT_stim] - Time (in milliseconds) of the rows of the basis</span>
</span><span id="getSimpleSpkHistBasis-50"><a href="#getSimpleSpkHistBasis-50"><span class="linenos">50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="getSimpleSpkHistBasis-51"><a href="#getSimpleSpkHistBasis-51"><span class="linenos">51</span></a>    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModifiedCardinalSpline</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">192</span><span class="p">],</span> <span class="n">binSize_ms</span><span class="o">=</span><span class="n">binSize_ms</span><span class="p">,</span> <span class="n">zero_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_first</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</span></pre></div>


            <div class="docstring"><p>A simple default basis to use for spike history filters made with a modified cardinal spline.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>binSize_ms:</strong>  time bin size in milliseconds</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A tuple (basis, time)</p>
  
  <p>basis: [BT_hspk x P_hspk] - Each column is a basis vector</p>
  
  <p>time:  [BT_stim] - Time (in milliseconds) of the rows of the basis</p>
</blockquote>
</div>


                </section>
                <section id="CBEM_basic">
                            <input id="CBEM_basic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CBEM_basic</span>:

                <label class="view-source-button" for="CBEM_basic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic-53"><a href="#CBEM_basic-53"><span class="linenos"> 53</span></a><span class="k">class</span> <span class="nc">CBEM_basic</span><span class="p">:</span>
</span><span id="CBEM_basic-54"><a href="#CBEM_basic-54"><span class="linenos"> 54</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-55"><a href="#CBEM_basic-55"><span class="linenos"> 55</span></a><span class="sd">    A basic implementation of the Conductance-based encoding model.</span>
</span><span id="CBEM_basic-56"><a href="#CBEM_basic-56"><span class="linenos"> 56</span></a><span class="sd">    The model has three inputs: excitatory and inhibitory conductance (soft-rectified, affine function in the stimulus)</span>
</span><span id="CBEM_basic-57"><a href="#CBEM_basic-57"><span class="linenos"> 57</span></a><span class="sd">                                a linear spike history (not conductance-based)</span>
</span><span id="CBEM_basic-58"><a href="#CBEM_basic-58"><span class="linenos"> 58</span></a><span class="sd">    The &#39;setObservations&#39; sets up the data: current stimulus and spike train.</span>
</span><span id="CBEM_basic-59"><a href="#CBEM_basic-59"><span class="linenos"> 59</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-60"><a href="#CBEM_basic-60"><span class="linenos"> 60</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">basis_conductance</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basis_hspk</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CBEM_basic-61"><a href="#CBEM_basic-61"><span class="linenos"> 61</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-62"><a href="#CBEM_basic-62"><span class="linenos"> 62</span></a><span class="sd">        Initialize simple CBEM with one excitatory and one inhibitory conductance which share input.</span>
</span><span id="CBEM_basic-63"><a href="#CBEM_basic-63"><span class="linenos"> 63</span></a><span class="sd">        </span>
</span><span id="CBEM_basic-64"><a href="#CBEM_basic-64"><span class="linenos"> 64</span></a><span class="sd">        Note: bases are orthogonalized before fitting. Filter parameters will be in terms of the orthogonalized basis.</span>
</span><span id="CBEM_basic-65"><a href="#CBEM_basic-65"><span class="linenos"> 65</span></a>
</span><span id="CBEM_basic-66"><a href="#CBEM_basic-66"><span class="linenos"> 66</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-67"><a href="#CBEM_basic-67"><span class="linenos"> 67</span></a><span class="sd">          binSize_ms:           time bin size in milliseconds</span>
</span><span id="CBEM_basic-68"><a href="#CBEM_basic-68"><span class="linenos"> 68</span></a><span class="sd">          basis_conductance:    [BT_stim x P_stim], if None then getSimpleStimulusBasis(binSize_ms) -</span>
</span><span id="CBEM_basic-69"><a href="#CBEM_basic-69"><span class="linenos"> 69</span></a><span class="sd">                                Each column is a basis function for the conductances (conductances share a basis).</span>
</span><span id="CBEM_basic-70"><a href="#CBEM_basic-70"><span class="linenos"> 70</span></a><span class="sd">                                The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</span>
</span><span id="CBEM_basic-71"><a href="#CBEM_basic-71"><span class="linenos"> 71</span></a><span class="sd">          basis_hspk:           [BT_hspk x P_hspk], if None then getSimpleSpkHistBasis(binSize_ms) -</span>
</span><span id="CBEM_basic-72"><a href="#CBEM_basic-72"><span class="linenos"> 72</span></a><span class="sd">                                Each column is a basis function for the spike history.</span>
</span><span id="CBEM_basic-73"><a href="#CBEM_basic-73"><span class="linenos"> 73</span></a><span class="sd">                                The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</span>
</span><span id="CBEM_basic-74"><a href="#CBEM_basic-74"><span class="linenos"> 74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-75"><a href="#CBEM_basic-75"><span class="linenos"> 75</span></a>
</span><span id="CBEM_basic-76"><a href="#CBEM_basic-76"><span class="linenos"> 76</span></a>        <span class="c1"># discretization size</span>
</span><span id="CBEM_basic-77"><a href="#CBEM_basic-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span>    <span class="o">=</span> <span class="n">binSize_ms</span><span class="p">;</span>
</span><span id="CBEM_basic-78"><a href="#CBEM_basic-78"><span class="linenos"> 78</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bin size must be positive&quot;</span>
</span><span id="CBEM_basic-79"><a href="#CBEM_basic-79"><span class="linenos"> 79</span></a>
</span><span id="CBEM_basic-80"><a href="#CBEM_basic-80"><span class="linenos"> 80</span></a>        <span class="c1"># setup bases for filters</span>
</span><span id="CBEM_basic-81"><a href="#CBEM_basic-81"><span class="linenos"> 81</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">basis_conductance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CBEM_basic-82"><a href="#CBEM_basic-82"><span class="linenos"> 82</span></a>            <span class="n">basis_conductance</span><span class="p">,</span><span class="n">tts</span> <span class="o">=</span> <span class="n">getSimpleStimulusBasis</span><span class="p">(</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="CBEM_basic-83"><a href="#CBEM_basic-83"><span class="linenos"> 83</span></a>            
</span><span id="CBEM_basic-84"><a href="#CBEM_basic-84"><span class="linenos"> 84</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">basis_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CBEM_basic-85"><a href="#CBEM_basic-85"><span class="linenos"> 85</span></a>            <span class="n">basis_hspk</span><span class="p">,</span><span class="n">tts</span> <span class="o">=</span> <span class="n">getSimpleSpkHistBasis</span><span class="p">(</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="CBEM_basic-86"><a href="#CBEM_basic-86"><span class="linenos"> 86</span></a>
</span><span id="CBEM_basic-87"><a href="#CBEM_basic-87"><span class="linenos"> 87</span></a>        <span class="k">assert</span> <span class="n">basis_conductance</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Basis cannot be more than 2 dimensions&quot;</span>
</span><span id="CBEM_basic-88"><a href="#CBEM_basic-88"><span class="linenos"> 88</span></a>        <span class="k">assert</span> <span class="n">basis_hspk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Basis cannot be more than 2 dimensions&quot;</span>
</span><span id="CBEM_basic-89"><a href="#CBEM_basic-89"><span class="linenos"> 89</span></a>
</span><span id="CBEM_basic-90"><a href="#CBEM_basic-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance_0</span> <span class="o">=</span> <span class="n">basis_conductance</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic-91"><a href="#CBEM_basic-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk_0</span>      <span class="o">=</span> <span class="n">basis_hspk</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic-92"><a href="#CBEM_basic-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">orth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance_0</span><span class="p">));</span>
</span><span id="CBEM_basic-93"><a href="#CBEM_basic-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span>        <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">orth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk_0</span> <span class="p">));</span>
</span><span id="CBEM_basic-94"><a href="#CBEM_basic-94"><span class="linenos"> 94</span></a>
</span><span id="CBEM_basic-95"><a href="#CBEM_basic-95"><span class="linenos"> 95</span></a>        <span class="c1"># setup LIF parameters </span>
</span><span id="CBEM_basic-96"><a href="#CBEM_basic-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">E_input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">]);</span> <span class="c1"># mV</span>
</span><span id="CBEM_basic-97"><a href="#CBEM_basic-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span> <span class="c1"># mV</span>
</span><span id="CBEM_basic-98"><a href="#CBEM_basic-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">g_l</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> 
</span><span id="CBEM_basic-99"><a href="#CBEM_basic-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span><span class="p">;</span> <span class="c1"># initial voltage</span>
</span><span id="CBEM_basic-100"><a href="#CBEM_basic-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">53</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span> <span class="p">:</span> <span class="mf">1.67</span><span class="p">};</span> <span class="c1"># &quot;beta&quot; : 1.67 or could be 1/0.45?</span>
</span><span id="CBEM_basic-101"><a href="#CBEM_basic-101"><span class="linenos">101</span></a>
</span><span id="CBEM_basic-102"><a href="#CBEM_basic-102"><span class="linenos">102</span></a>        <span class="c1"># no stimulus set yet - won&#39;t run model</span>
</span><span id="CBEM_basic-103"><a href="#CBEM_basic-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic-104"><a href="#CBEM_basic-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic-105"><a href="#CBEM_basic-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic-106"><a href="#CBEM_basic-106"><span class="linenos">106</span></a>
</span><span id="CBEM_basic-107"><a href="#CBEM_basic-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic-108"><a href="#CBEM_basic-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic-109"><a href="#CBEM_basic-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="CBEM_basic-110"><a href="#CBEM_basic-110"><span class="linenos">110</span></a>
</span><span id="CBEM_basic-111"><a href="#CBEM_basic-111"><span class="linenos">111</span></a>    <span class="c1"># Properties for the model parameters</span>
</span><span id="CBEM_basic-112"><a href="#CBEM_basic-112"><span class="linenos">112</span></a>    <span class="nd">@property</span>
</span><span id="CBEM_basic-113"><a href="#CBEM_basic-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">B_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CBEM_basic-114"><a href="#CBEM_basic-114"><span class="linenos">114</span></a>        <span class="sd">&quot;&quot;&quot;jnp.ndarray: [(BT_stim + 1) x 2] - The conductance filters and baseline parameters.&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-115"><a href="#CBEM_basic-115"><span class="linenos">115</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">;</span>
</span><span id="CBEM_basic-116"><a href="#CBEM_basic-116"><span class="linenos">116</span></a>
</span><span id="CBEM_basic-117"><a href="#CBEM_basic-117"><span class="linenos">117</span></a>    <span class="nd">@B_cond</span><span class="o">.</span><span class="n">setter</span>
</span><span id="CBEM_basic-118"><a href="#CBEM_basic-118"><span class="linenos">118</span></a>    <span class="k">def</span> <span class="nf">B_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="CBEM_basic-119"><a href="#CBEM_basic-119"><span class="linenos">119</span></a>        <span class="sd">&quot;&quot;&quot;Note: cannot change filter size&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-120"><a href="#CBEM_basic-120"><span class="linenos">120</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-121"><a href="#CBEM_basic-121"><span class="linenos">121</span></a>        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;Conductance filter is incorrect shape&quot;</span>
</span><span id="CBEM_basic-122"><a href="#CBEM_basic-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span id="CBEM_basic-123"><a href="#CBEM_basic-123"><span class="linenos">123</span></a>
</span><span id="CBEM_basic-124"><a href="#CBEM_basic-124"><span class="linenos">124</span></a>    <span class="nd">@property</span>
</span><span id="CBEM_basic-125"><a href="#CBEM_basic-125"><span class="linenos">125</span></a>    <span class="k">def</span> <span class="nf">B_hspk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CBEM_basic-126"><a href="#CBEM_basic-126"><span class="linenos">126</span></a>        <span class="sd">&quot;&quot;&quot;jnp.ndarray: [BT_hspk x 1] - The spike history filter parameters.&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-127"><a href="#CBEM_basic-127"><span class="linenos">127</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">;</span>
</span><span id="CBEM_basic-128"><a href="#CBEM_basic-128"><span class="linenos">128</span></a>
</span><span id="CBEM_basic-129"><a href="#CBEM_basic-129"><span class="linenos">129</span></a>    <span class="nd">@B_hspk</span><span class="o">.</span><span class="n">setter</span>
</span><span id="CBEM_basic-130"><a href="#CBEM_basic-130"><span class="linenos">130</span></a>    <span class="k">def</span> <span class="nf">B_hspk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="CBEM_basic-131"><a href="#CBEM_basic-131"><span class="linenos">131</span></a>        <span class="sd">&quot;&quot;&quot;Note: cannot change filter size&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-132"><a href="#CBEM_basic-132"><span class="linenos">132</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-133"><a href="#CBEM_basic-133"><span class="linenos">133</span></a>        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;Spike history filter is incorrect shape&quot;</span>
</span><span id="CBEM_basic-134"><a href="#CBEM_basic-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span id="CBEM_basic-135"><a href="#CBEM_basic-135"><span class="linenos">135</span></a>
</span><span id="CBEM_basic-136"><a href="#CBEM_basic-136"><span class="linenos">136</span></a>
</span><span id="CBEM_basic-137"><a href="#CBEM_basic-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="nf">setObservations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Stimulus</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">spkTimes_bins</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">window</span> <span class="p">:</span> <span class="nb">range</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-138"><a href="#CBEM_basic-138"><span class="linenos">138</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-139"><a href="#CBEM_basic-139"><span class="linenos">139</span></a><span class="sd">        Initializes the stimulus and spike train observation for this neuron.</span>
</span><span id="CBEM_basic-140"><a href="#CBEM_basic-140"><span class="linenos">140</span></a><span class="sd">        This assumes only one spike per bin is possible.</span>
</span><span id="CBEM_basic-141"><a href="#CBEM_basic-141"><span class="linenos">141</span></a>
</span><span id="CBEM_basic-142"><a href="#CBEM_basic-142"><span class="linenos">142</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-143"><a href="#CBEM_basic-143"><span class="linenos">143</span></a><span class="sd">          Stimulus:         [T_stim x number of pixels] - Pixels are treated independently</span>
</span><span id="CBEM_basic-144"><a href="#CBEM_basic-144"><span class="linenos">144</span></a><span class="sd">          spkTimes_bins:    List of the spike times in bins.</span>
</span><span id="CBEM_basic-145"><a href="#CBEM_basic-145"><span class="linenos">145</span></a><span class="sd">          window:           The window of stimulus and spikes to fit. This input allows you to cut out the first </span>
</span><span id="CBEM_basic-146"><a href="#CBEM_basic-146"><span class="linenos">146</span></a><span class="sd">                            part of the given spike train to avoid edge effects for spike history or stimulus.</span>
</span><span id="CBEM_basic-147"><a href="#CBEM_basic-147"><span class="linenos">147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-148"><a href="#CBEM_basic-148"><span class="linenos">148</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
</span><span id="CBEM_basic-149"><a href="#CBEM_basic-149"><span class="linenos">149</span></a>        <span class="c1"># get the conductance desgin matrix(same for both conductances)</span>
</span><span id="CBEM_basic-150"><a href="#CBEM_basic-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">convolveStimulusWithBasis</span><span class="p">(</span><span class="n">Stimulus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="p">)[</span><span class="n">window</span><span class="p">,:]);</span>
</span><span id="CBEM_basic-151"><a href="#CBEM_basic-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
</span><span id="CBEM_basic-152"><a href="#CBEM_basic-152"><span class="linenos">152</span></a>
</span><span id="CBEM_basic-153"><a href="#CBEM_basic-153"><span class="linenos">153</span></a>        <span class="c1"># get spike history</span>
</span><span id="CBEM_basic-154"><a href="#CBEM_basic-154"><span class="linenos">154</span></a>        <span class="n">X_l</span><span class="p">,</span> <span class="n">Y_0</span>      <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">convolveSpksWithBasis</span><span class="p">(</span><span class="n">spkTimes_bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="p">,</span> <span class="n">Stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="CBEM_basic-155"><a href="#CBEM_basic-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span>    <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_l</span><span class="p">[</span><span class="n">window</span><span class="p">,:]);</span>
</span><span id="CBEM_basic-156"><a href="#CBEM_basic-156"><span class="linenos">156</span></a>
</span><span id="CBEM_basic-157"><a href="#CBEM_basic-157"><span class="linenos">157</span></a>        <span class="c1"># get spike times within the current window</span>
</span><span id="CBEM_basic-158"><a href="#CBEM_basic-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span>              <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_0</span><span class="p">[</span><span class="n">window</span><span class="p">]);</span> <span class="c1"># vectorized spike times</span>
</span><span id="CBEM_basic-159"><a href="#CBEM_basic-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">spkTimes_bins</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span> 
</span><span id="CBEM_basic-160"><a href="#CBEM_basic-160"><span class="linenos">160</span></a>        
</span><span id="CBEM_basic-161"><a href="#CBEM_basic-161"><span class="linenos">161</span></a>        <span class="c1"># setup empty parameters</span>
</span><span id="CBEM_basic-162"><a href="#CBEM_basic-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span><span id="CBEM_basic-163"><a href="#CBEM_basic-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span><span id="CBEM_basic-164"><a href="#CBEM_basic-164"><span class="linenos">164</span></a>
</span><span id="CBEM_basic-165"><a href="#CBEM_basic-165"><span class="linenos">165</span></a>    <span class="c1">### functions for handling the voltage model</span>
</span><span id="CBEM_basic-166"><a href="#CBEM_basic-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">getConductances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-167"><a href="#CBEM_basic-167"><span class="linenos">167</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-168"><a href="#CBEM_basic-168"><span class="linenos">168</span></a><span class="sd">        Computes the conductances given the conductance filter parameters for the current stimulus.</span>
</span><span id="CBEM_basic-169"><a href="#CBEM_basic-169"><span class="linenos">169</span></a><span class="sd">        The conductance nonlinearity is a soft-rectifier.</span>
</span><span id="CBEM_basic-170"><a href="#CBEM_basic-170"><span class="linenos">170</span></a>
</span><span id="CBEM_basic-171"><a href="#CBEM_basic-171"><span class="linenos">171</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-172"><a href="#CBEM_basic-172"><span class="linenos">172</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.get_B_cond() -</span>
</span><span id="CBEM_basic-173"><a href="#CBEM_basic-173"><span class="linenos">173</span></a><span class="sd">                        Parameters of the two conductance filters as weights on the basis functions. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-174"><a href="#CBEM_basic-174"><span class="linenos">174</span></a><span class="sd">                        The last entry is the basline term.</span>
</span><span id="CBEM_basic-175"><a href="#CBEM_basic-175"><span class="linenos">175</span></a><span class="sd">        </span>
</span><span id="CBEM_basic-176"><a href="#CBEM_basic-176"><span class="linenos">176</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-177"><a href="#CBEM_basic-177"><span class="linenos">177</span></a><span class="sd">          gs  [T_stim x 2] - first column is excitatory conductance, second inhibitory</span>
</span><span id="CBEM_basic-178"><a href="#CBEM_basic-178"><span class="linenos">178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-179"><a href="#CBEM_basic-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-180"><a href="#CBEM_basic-180"><span class="linenos">180</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic-181"><a href="#CBEM_basic-181"><span class="linenos">181</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Stimulus not initialized!&quot;</span>
</span><span id="CBEM_basic-182"><a href="#CBEM_basic-182"><span class="linenos">182</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B_cond</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">),</span> <span class="s2">&quot;Conductance parameters not correct shape&quot;</span>
</span><span id="CBEM_basic-183"><a href="#CBEM_basic-183"><span class="linenos">183</span></a>
</span><span id="CBEM_basic-184"><a href="#CBEM_basic-184"><span class="linenos">184</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="o">@</span> <span class="n">B_cond</span><span class="p">);</span>
</span><span id="CBEM_basic-185"><a href="#CBEM_basic-185"><span class="linenos">185</span></a>
</span><span id="CBEM_basic-186"><a href="#CBEM_basic-186"><span class="linenos">186</span></a>    <span class="k">def</span> <span class="nf">getVoltage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-187"><a href="#CBEM_basic-187"><span class="linenos">187</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-188"><a href="#CBEM_basic-188"><span class="linenos">188</span></a><span class="sd">        Computes the voltage given the conductance parameters for the set stimulus.</span>
</span><span id="CBEM_basic-189"><a href="#CBEM_basic-189"><span class="linenos">189</span></a><span class="sd">        </span>
</span><span id="CBEM_basic-190"><a href="#CBEM_basic-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-191"><a href="#CBEM_basic-191"><span class="linenos">191</span></a><span class="sd">          B_cond:  [(P_stim + 1) x 2], if None then  self.get_B_cond() -</span>
</span><span id="CBEM_basic-192"><a href="#CBEM_basic-192"><span class="linenos">192</span></a><span class="sd">                        Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-193"><a href="#CBEM_basic-193"><span class="linenos">193</span></a><span class="sd">                        The last entry is the basline term.</span>
</span><span id="CBEM_basic-194"><a href="#CBEM_basic-194"><span class="linenos">194</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic-195"><a href="#CBEM_basic-195"><span class="linenos">195</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-196"><a href="#CBEM_basic-196"><span class="linenos">196</span></a><span class="sd">          V [T_stim] - the solved voltage in millivolts</span>
</span><span id="CBEM_basic-197"><a href="#CBEM_basic-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-198"><a href="#CBEM_basic-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-199"><a href="#CBEM_basic-199"><span class="linenos">199</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic-200"><a href="#CBEM_basic-200"><span class="linenos">200</span></a>
</span><span id="CBEM_basic-201"><a href="#CBEM_basic-201"><span class="linenos">201</span></a>        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConductances</span><span class="p">(</span><span class="n">B_cond</span><span class="p">);</span>
</span><span id="CBEM_basic-202"><a href="#CBEM_basic-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">)(</span><span class="n">gs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="CBEM_basic-203"><a href="#CBEM_basic-203"><span class="linenos">203</span></a>
</span><span id="CBEM_basic-204"><a href="#CBEM_basic-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">firingRateNonlinearity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V_tot</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-205"><a href="#CBEM_basic-205"><span class="linenos">205</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-206"><a href="#CBEM_basic-206"><span class="linenos">206</span></a><span class="sd">        Computes the firing rate nonlinearity on the given total voltage.</span>
</span><span id="CBEM_basic-207"><a href="#CBEM_basic-207"><span class="linenos">207</span></a><span class="sd">        The nonlinearity is alpha * softplus((V_tot - mu)/beta)</span>
</span><span id="CBEM_basic-208"><a href="#CBEM_basic-208"><span class="linenos">208</span></a>
</span><span id="CBEM_basic-209"><a href="#CBEM_basic-209"><span class="linenos">209</span></a><span class="sd">        - self.frNonlinearity holds the parameters alpha, beta, and mu</span>
</span><span id="CBEM_basic-210"><a href="#CBEM_basic-210"><span class="linenos">210</span></a>
</span><span id="CBEM_basic-211"><a href="#CBEM_basic-211"><span class="linenos">211</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-212"><a href="#CBEM_basic-212"><span class="linenos">212</span></a><span class="sd">          V_tot:    [T] - The total voltage terms.</span>
</span><span id="CBEM_basic-213"><a href="#CBEM_basic-213"><span class="linenos">213</span></a><span class="sd">                    Total voltage is the membrane potential from the membrane potential equation plus spike history terms.</span>
</span><span id="CBEM_basic-214"><a href="#CBEM_basic-214"><span class="linenos">214</span></a>
</span><span id="CBEM_basic-215"><a href="#CBEM_basic-215"><span class="linenos">215</span></a><span class="sd">        Returns:              </span>
</span><span id="CBEM_basic-216"><a href="#CBEM_basic-216"><span class="linenos">216</span></a><span class="sd">          spikeRate [T] - the firing rate for each term in V_tot</span>
</span><span id="CBEM_basic-217"><a href="#CBEM_basic-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-218"><a href="#CBEM_basic-218"><span class="linenos">218</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">((</span><span class="n">V_tot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">])</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]);</span>
</span><span id="CBEM_basic-219"><a href="#CBEM_basic-219"><span class="linenos">219</span></a>
</span><span id="CBEM_basic-220"><a href="#CBEM_basic-220"><span class="linenos">220</span></a>    <span class="k">def</span> <span class="nf">getSpikeHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-221"><a href="#CBEM_basic-221"><span class="linenos">221</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-222"><a href="#CBEM_basic-222"><span class="linenos">222</span></a><span class="sd">        Computes the spike history given the parameters for the set spike train. (A simple linear function)</span>
</span><span id="CBEM_basic-223"><a href="#CBEM_basic-223"><span class="linenos">223</span></a>
</span><span id="CBEM_basic-224"><a href="#CBEM_basic-224"><span class="linenos">224</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-225"><a href="#CBEM_basic-225"><span class="linenos">225</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic-226"><a href="#CBEM_basic-226"><span class="linenos">226</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic-227"><a href="#CBEM_basic-227"><span class="linenos">227</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-228"><a href="#CBEM_basic-228"><span class="linenos">228</span></a><span class="sd">          hspk  [T_stim] - the linear spike history</span>
</span><span id="CBEM_basic-229"><a href="#CBEM_basic-229"><span class="linenos">229</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-230"><a href="#CBEM_basic-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-231"><a href="#CBEM_basic-231"><span class="linenos">231</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic-232"><a href="#CBEM_basic-232"><span class="linenos">232</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B_hspk</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">),</span> <span class="s2">&quot;Linear parameters not correct shape&quot;</span>
</span><span id="CBEM_basic-233"><a href="#CBEM_basic-233"><span class="linenos">233</span></a>
</span><span id="CBEM_basic-234"><a href="#CBEM_basic-234"><span class="linenos">234</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span> <span class="o">@</span> <span class="n">B_hspk</span><span class="p">;</span>
</span><span id="CBEM_basic-235"><a href="#CBEM_basic-235"><span class="linenos">235</span></a>
</span><span id="CBEM_basic-236"><a href="#CBEM_basic-236"><span class="linenos">236</span></a>    <span class="k">def</span> <span class="nf">getSpikeRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span>  <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span>  <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-237"><a href="#CBEM_basic-237"><span class="linenos">237</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-238"><a href="#CBEM_basic-238"><span class="linenos">238</span></a><span class="sd">        Computes the spike rate at each time given the conductance and spike history parameters for the set stimulus &amp; spike history.</span>
</span><span id="CBEM_basic-239"><a href="#CBEM_basic-239"><span class="linenos">239</span></a>
</span><span id="CBEM_basic-240"><a href="#CBEM_basic-240"><span class="linenos">240</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-241"><a href="#CBEM_basic-241"><span class="linenos">241</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then  self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-242"><a href="#CBEM_basic-242"><span class="linenos">242</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic-243"><a href="#CBEM_basic-243"><span class="linenos">243</span></a>
</span><span id="CBEM_basic-244"><a href="#CBEM_basic-244"><span class="linenos">244</span></a><span class="sd">        Returns            </span>
</span><span id="CBEM_basic-245"><a href="#CBEM_basic-245"><span class="linenos">245</span></a><span class="sd">          spikeRate [T_stim] - the firing rate in each bin in units of spikes/sec</span>
</span><span id="CBEM_basic-246"><a href="#CBEM_basic-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-247"><a href="#CBEM_basic-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-248"><a href="#CBEM_basic-248"><span class="linenos">248</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic-249"><a href="#CBEM_basic-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-250"><a href="#CBEM_basic-250"><span class="linenos">250</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic-251"><a href="#CBEM_basic-251"><span class="linenos">251</span></a>
</span><span id="CBEM_basic-252"><a href="#CBEM_basic-252"><span class="linenos">252</span></a>        <span class="n">V_tot</span>  <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">(</span><span class="n">B_cond</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpikeHistory</span><span class="p">(</span><span class="n">B_hspk</span><span class="p">);</span> <span class="c1"># add membrane voltage and spike history </span>
</span><span id="CBEM_basic-253"><a href="#CBEM_basic-253"><span class="linenos">253</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">firingRateNonlinearity</span><span class="p">(</span><span class="n">V_tot</span><span class="p">);</span> <span class="c1"># pass through transfer function</span>
</span><span id="CBEM_basic-254"><a href="#CBEM_basic-254"><span class="linenos">254</span></a>
</span><span id="CBEM_basic-255"><a href="#CBEM_basic-255"><span class="linenos">255</span></a>    <span class="c1">### log likelihood of spikes</span>
</span><span id="CBEM_basic-256"><a href="#CBEM_basic-256"><span class="linenos">256</span></a>    <span class="k">def</span> <span class="nf">getLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-257"><a href="#CBEM_basic-257"><span class="linenos">257</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-258"><a href="#CBEM_basic-258"><span class="linenos">258</span></a><span class="sd">        Computes the log likelihood at each time bin given the conductance and spike history parameters for the set stimulus &amp; spike history.</span>
</span><span id="CBEM_basic-259"><a href="#CBEM_basic-259"><span class="linenos">259</span></a><span class="sd">        This function uses a truncated Poisson likelihood. That is, Poisson(0 | rate) for bins without a spike and</span>
</span><span id="CBEM_basic-260"><a href="#CBEM_basic-260"><span class="linenos">260</span></a><span class="sd">                                                                 (1-Poisson(0 | rate)) for bins with a spike.</span>
</span><span id="CBEM_basic-261"><a href="#CBEM_basic-261"><span class="linenos">261</span></a>
</span><span id="CBEM_basic-262"><a href="#CBEM_basic-262"><span class="linenos">262</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-263"><a href="#CBEM_basic-263"><span class="linenos">263</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-264"><a href="#CBEM_basic-264"><span class="linenos">264</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic-265"><a href="#CBEM_basic-265"><span class="linenos">265</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic-266"><a href="#CBEM_basic-266"><span class="linenos">266</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-267"><a href="#CBEM_basic-267"><span class="linenos">267</span></a><span class="sd">          ll_bins [T_stim] - the log likelihood of the observation (a spike or no spike) at each bin.</span>
</span><span id="CBEM_basic-268"><a href="#CBEM_basic-268"><span class="linenos">268</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-269"><a href="#CBEM_basic-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-270"><a href="#CBEM_basic-270"><span class="linenos">270</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic-271"><a href="#CBEM_basic-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-272"><a href="#CBEM_basic-272"><span class="linenos">272</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic-273"><a href="#CBEM_basic-273"><span class="linenos">273</span></a>
</span><span id="CBEM_basic-274"><a href="#CBEM_basic-274"><span class="linenos">274</span></a>        <span class="n">ll_bins</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpikeRate</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">);</span>
</span><span id="CBEM_basic-275"><a href="#CBEM_basic-275"><span class="linenos">275</span></a>        <span class="n">ll_bins</span> <span class="o">=</span> <span class="n">ll_bins</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ll_bins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span><span class="p">])));</span>
</span><span id="CBEM_basic-276"><a href="#CBEM_basic-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="n">ll_bins</span><span class="p">;</span>
</span><span id="CBEM_basic-277"><a href="#CBEM_basic-277"><span class="linenos">277</span></a>
</span><span id="CBEM_basic-278"><a href="#CBEM_basic-278"><span class="linenos">278</span></a>    <span class="c1">### functions for handling parameters</span>
</span><span id="CBEM_basic-279"><a href="#CBEM_basic-279"><span class="linenos">279</span></a>    <span class="k">def</span> <span class="nf">randomizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset_term_mean</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">std_cond</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">std_lin</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-280"><a href="#CBEM_basic-280"><span class="linenos">280</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-281"><a href="#CBEM_basic-281"><span class="linenos">281</span></a><span class="sd">        Sets the parameters of the model using i.i.d. normal draws.</span>
</span><span id="CBEM_basic-282"><a href="#CBEM_basic-282"><span class="linenos">282</span></a><span class="sd">        All filter weights are drawn with mean 0.</span>
</span><span id="CBEM_basic-283"><a href="#CBEM_basic-283"><span class="linenos">283</span></a>
</span><span id="CBEM_basic-284"><a href="#CBEM_basic-284"><span class="linenos">284</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-285"><a href="#CBEM_basic-285"><span class="linenos">285</span></a><span class="sd">          offset_term_mean: Mean of the baseline term of the conductances. This probably should be positive.</span>
</span><span id="CBEM_basic-286"><a href="#CBEM_basic-286"><span class="linenos">286</span></a><span class="sd">          std_cond:         Standard deviation of the conductance parameters.</span>
</span><span id="CBEM_basic-287"><a href="#CBEM_basic-287"><span class="linenos">287</span></a><span class="sd">          std_lin:          Standard deviation of the spike history parameters.</span>
</span><span id="CBEM_basic-288"><a href="#CBEM_basic-288"><span class="linenos">288</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic-289"><a href="#CBEM_basic-289"><span class="linenos">289</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-290"><a href="#CBEM_basic-290"><span class="linenos">290</span></a><span class="sd">          A tuple (B_cond, B_hspk)</span>
</span><span id="CBEM_basic-291"><a href="#CBEM_basic-291"><span class="linenos">291</span></a>
</span><span id="CBEM_basic-292"><a href="#CBEM_basic-292"><span class="linenos">292</span></a><span class="sd">            B_cond: [(P_stim + 1) x 2] - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-293"><a href="#CBEM_basic-293"><span class="linenos">293</span></a>
</span><span id="CBEM_basic-294"><a href="#CBEM_basic-294"><span class="linenos">294</span></a><span class="sd">            B_hspk:  [P_hspk x 1] - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic-295"><a href="#CBEM_basic-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-296"><a href="#CBEM_basic-296"><span class="linenos">296</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-297"><a href="#CBEM_basic-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std_cond</span><span class="p">);</span>
</span><span id="CBEM_basic-298"><a href="#CBEM_basic-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std_lin</span><span class="p">);</span>
</span><span id="CBEM_basic-299"><a href="#CBEM_basic-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">offset_term_mean</span><span class="p">);</span>
</span><span id="CBEM_basic-300"><a href="#CBEM_basic-300"><span class="linenos">300</span></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">);</span>
</span><span id="CBEM_basic-301"><a href="#CBEM_basic-301"><span class="linenos">301</span></a>
</span><span id="CBEM_basic-302"><a href="#CBEM_basic-302"><span class="linenos">302</span></a>
</span><span id="CBEM_basic-303"><a href="#CBEM_basic-303"><span class="linenos">303</span></a>    <span class="k">def</span> <span class="nf">vectorizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-304"><a href="#CBEM_basic-304"><span class="linenos">304</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-305"><a href="#CBEM_basic-305"><span class="linenos">305</span></a><span class="sd">        Flatens the parameters into a vector for optimization.</span>
</span><span id="CBEM_basic-306"><a href="#CBEM_basic-306"><span class="linenos">306</span></a>
</span><span id="CBEM_basic-307"><a href="#CBEM_basic-307"><span class="linenos">307</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-308"><a href="#CBEM_basic-308"><span class="linenos">308</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.B_cond -</span>
</span><span id="CBEM_basic-309"><a href="#CBEM_basic-309"><span class="linenos">309</span></a><span class="sd">                    Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-310"><a href="#CBEM_basic-310"><span class="linenos">310</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then self.B_hspk -</span>
</span><span id="CBEM_basic-311"><a href="#CBEM_basic-311"><span class="linenos">311</span></a><span class="sd">                    Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic-312"><a href="#CBEM_basic-312"><span class="linenos">312</span></a><span class="sd">                    The last entry is the basline term.</span>
</span><span id="CBEM_basic-313"><a href="#CBEM_basic-313"><span class="linenos">313</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic-314"><a href="#CBEM_basic-314"><span class="linenos">314</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-315"><a href="#CBEM_basic-315"><span class="linenos">315</span></a><span class="sd">          B [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk</span>
</span><span id="CBEM_basic-316"><a href="#CBEM_basic-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-317"><a href="#CBEM_basic-317"><span class="linenos">317</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-318"><a href="#CBEM_basic-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-319"><a href="#CBEM_basic-319"><span class="linenos">319</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic-320"><a href="#CBEM_basic-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-321"><a href="#CBEM_basic-321"><span class="linenos">321</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic-322"><a href="#CBEM_basic-322"><span class="linenos">322</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">B_cond</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">B_hspk</span><span class="o">.</span><span class="n">flatten</span><span class="p">()));</span>
</span><span id="CBEM_basic-323"><a href="#CBEM_basic-323"><span class="linenos">323</span></a>
</span><span id="CBEM_basic-324"><a href="#CBEM_basic-324"><span class="linenos">324</span></a>    <span class="k">def</span> <span class="nf">devectorizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="CBEM_basic-325"><a href="#CBEM_basic-325"><span class="linenos">325</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-326"><a href="#CBEM_basic-326"><span class="linenos">326</span></a><span class="sd">        Takens in a vector of the parameters and returns them in more convenient separate, matrix forms.</span>
</span><span id="CBEM_basic-327"><a href="#CBEM_basic-327"><span class="linenos">327</span></a>
</span><span id="CBEM_basic-328"><a href="#CBEM_basic-328"><span class="linenos">328</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-329"><a href="#CBEM_basic-329"><span class="linenos">329</span></a><span class="sd">          B:  [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic-330"><a href="#CBEM_basic-330"><span class="linenos">330</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic-331"><a href="#CBEM_basic-331"><span class="linenos">331</span></a><span class="sd">        </span>
</span><span id="CBEM_basic-332"><a href="#CBEM_basic-332"><span class="linenos">332</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-333"><a href="#CBEM_basic-333"><span class="linenos">333</span></a><span class="sd">          A tuple (B_cond, B_hspk)</span>
</span><span id="CBEM_basic-334"><a href="#CBEM_basic-334"><span class="linenos">334</span></a>
</span><span id="CBEM_basic-335"><a href="#CBEM_basic-335"><span class="linenos">335</span></a><span class="sd">            B_cond: [(P_stim + 1) x 2] - </span>
</span><span id="CBEM_basic-336"><a href="#CBEM_basic-336"><span class="linenos">336</span></a><span class="sd">                Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic-337"><a href="#CBEM_basic-337"><span class="linenos">337</span></a>
</span><span id="CBEM_basic-338"><a href="#CBEM_basic-338"><span class="linenos">338</span></a><span class="sd">            B_hspk:  [P_hspk x 1] - </span>
</span><span id="CBEM_basic-339"><a href="#CBEM_basic-339"><span class="linenos">339</span></a><span class="sd">                Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic-340"><a href="#CBEM_basic-340"><span class="linenos">340</span></a><span class="sd">                The last entry is the basline term.</span>
</span><span id="CBEM_basic-341"><a href="#CBEM_basic-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-342"><a href="#CBEM_basic-342"><span class="linenos">342</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-343"><a href="#CBEM_basic-343"><span class="linenos">343</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;B is incorrect size: must be a vector containing both conductance and linear terms&quot;</span>
</span><span id="CBEM_basic-344"><a href="#CBEM_basic-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>  <span class="n">B</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span>
</span><span id="CBEM_basic-345"><a href="#CBEM_basic-345"><span class="linenos">345</span></a>
</span><span id="CBEM_basic-346"><a href="#CBEM_basic-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">setParametersFromVector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-347"><a href="#CBEM_basic-347"><span class="linenos">347</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-348"><a href="#CBEM_basic-348"><span class="linenos">348</span></a><span class="sd">        Sets the current parameters from a vectorized form.</span>
</span><span id="CBEM_basic-349"><a href="#CBEM_basic-349"><span class="linenos">349</span></a>
</span><span id="CBEM_basic-350"><a href="#CBEM_basic-350"><span class="linenos">350</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-351"><a href="#CBEM_basic-351"><span class="linenos">351</span></a><span class="sd">          B:    [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic-352"><a href="#CBEM_basic-352"><span class="linenos">352</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic-353"><a href="#CBEM_basic-353"><span class="linenos">353</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-354"><a href="#CBEM_basic-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</span><span id="CBEM_basic-355"><a href="#CBEM_basic-355"><span class="linenos">355</span></a>
</span><span id="CBEM_basic-356"><a href="#CBEM_basic-356"><span class="linenos">356</span></a>
</span><span id="CBEM_basic-357"><a href="#CBEM_basic-357"><span class="linenos">357</span></a>
</span><span id="CBEM_basic-358"><a href="#CBEM_basic-358"><span class="linenos">358</span></a>    <span class="c1"># Vectorized negative log likelihood functions for optimization</span>
</span><span id="CBEM_basic-359"><a href="#CBEM_basic-359"><span class="linenos">359</span></a>    <span class="k">def</span> <span class="nf">vectorizedNegLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-360"><a href="#CBEM_basic-360"><span class="linenos">360</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-361"><a href="#CBEM_basic-361"><span class="linenos">361</span></a><span class="sd">        Computes the negative log likelihood for the set stimulus and spike train.</span>
</span><span id="CBEM_basic-362"><a href="#CBEM_basic-362"><span class="linenos">362</span></a><span class="sd">        Takes in the parameters in a vectorized form for use with optimizers.</span>
</span><span id="CBEM_basic-363"><a href="#CBEM_basic-363"><span class="linenos">363</span></a>
</span><span id="CBEM_basic-364"><a href="#CBEM_basic-364"><span class="linenos">364</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-365"><a href="#CBEM_basic-365"><span class="linenos">365</span></a><span class="sd">          B:    [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic-366"><a href="#CBEM_basic-366"><span class="linenos">366</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic-367"><a href="#CBEM_basic-367"><span class="linenos">367</span></a>
</span><span id="CBEM_basic-368"><a href="#CBEM_basic-368"><span class="linenos">368</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-369"><a href="#CBEM_basic-369"><span class="linenos">369</span></a><span class="sd">          nll [1] - The total negative log likelihood for the setup stimulus.</span>
</span><span id="CBEM_basic-370"><a href="#CBEM_basic-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-371"><a href="#CBEM_basic-371"><span class="linenos">371</span></a>        <span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="CBEM_basic-372"><a href="#CBEM_basic-372"><span class="linenos">372</span></a>        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogLike</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">());</span>
</span><span id="CBEM_basic-373"><a href="#CBEM_basic-373"><span class="linenos">373</span></a>        
</span><span id="CBEM_basic-374"><a href="#CBEM_basic-374"><span class="linenos">374</span></a>    <span class="k">def</span> <span class="nf">vectorizedPenalizedNegLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">conductance_penalty</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-375"><a href="#CBEM_basic-375"><span class="linenos">375</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-376"><a href="#CBEM_basic-376"><span class="linenos">376</span></a><span class="sd">        Computes the penalized negative log likelihood for the set stimulus and spike train.</span>
</span><span id="CBEM_basic-377"><a href="#CBEM_basic-377"><span class="linenos">377</span></a><span class="sd">        Takes in the parameters in a vectorized form for use with optimizers.</span>
</span><span id="CBEM_basic-378"><a href="#CBEM_basic-378"><span class="linenos">378</span></a><span class="sd">        The penalty terms are the weighted squared norms of the conductance filters.</span>
</span><span id="CBEM_basic-379"><a href="#CBEM_basic-379"><span class="linenos">379</span></a><span class="sd">        </span>
</span><span id="CBEM_basic-380"><a href="#CBEM_basic-380"><span class="linenos">380</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-381"><a href="#CBEM_basic-381"><span class="linenos">381</span></a><span class="sd">          B: [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic-382"><a href="#CBEM_basic-382"><span class="linenos">382</span></a><span class="sd">                    This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic-383"><a href="#CBEM_basic-383"><span class="linenos">383</span></a><span class="sd">          conductance_penalty:  [2] -</span>
</span><span id="CBEM_basic-384"><a href="#CBEM_basic-384"><span class="linenos">384</span></a><span class="sd">                    The weights of the penalty on the squared norms of the filter weights.</span>
</span><span id="CBEM_basic-385"><a href="#CBEM_basic-385"><span class="linenos">385</span></a><span class="sd">                    The first term is for the excitatory and the second for the inhibitory.</span>
</span><span id="CBEM_basic-386"><a href="#CBEM_basic-386"><span class="linenos">386</span></a><span class="sd">                    The baseline conductance terms do not contribute to this penalty.</span>
</span><span id="CBEM_basic-387"><a href="#CBEM_basic-387"><span class="linenos">387</span></a>
</span><span id="CBEM_basic-388"><a href="#CBEM_basic-388"><span class="linenos">388</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-389"><a href="#CBEM_basic-389"><span class="linenos">389</span></a><span class="sd">          nll [1] - The total negative log likelihood for the setup stimulus plus the penalties.</span>
</span><span id="CBEM_basic-390"><a href="#CBEM_basic-390"><span class="linenos">390</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-391"><a href="#CBEM_basic-391"><span class="linenos">391</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-392"><a href="#CBEM_basic-392"><span class="linenos">392</span></a>        <span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="CBEM_basic-393"><a href="#CBEM_basic-393"><span class="linenos">393</span></a>        <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogLike</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">());</span>
</span><span id="CBEM_basic-394"><a href="#CBEM_basic-394"><span class="linenos">394</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="CBEM_basic-395"><a href="#CBEM_basic-395"><span class="linenos">395</span></a>            <span class="n">nll</span> <span class="o">+=</span> <span class="n">conductance_penalty</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">);</span>
</span><span id="CBEM_basic-396"><a href="#CBEM_basic-396"><span class="linenos">396</span></a>        <span class="k">return</span> <span class="n">nll</span><span class="p">;</span>
</span><span id="CBEM_basic-397"><a href="#CBEM_basic-397"><span class="linenos">397</span></a>
</span><span id="CBEM_basic-398"><a href="#CBEM_basic-398"><span class="linenos">398</span></a>    <span class="k">def</span> <span class="nf">getConductanceFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-399"><a href="#CBEM_basic-399"><span class="linenos">399</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-400"><a href="#CBEM_basic-400"><span class="linenos">400</span></a><span class="sd">        Gets the full conductance filter (basis times weights) for one of the conductance filters.</span>
</span><span id="CBEM_basic-401"><a href="#CBEM_basic-401"><span class="linenos">401</span></a>
</span><span id="CBEM_basic-402"><a href="#CBEM_basic-402"><span class="linenos">402</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-403"><a href="#CBEM_basic-403"><span class="linenos">403</span></a><span class="sd">          cc: Index of the conductance filter to return. 0 is excitatory, 1 is inhibitory.</span>
</span><span id="CBEM_basic-404"><a href="#CBEM_basic-404"><span class="linenos">404</span></a>
</span><span id="CBEM_basic-405"><a href="#CBEM_basic-405"><span class="linenos">405</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-406"><a href="#CBEM_basic-406"><span class="linenos">406</span></a><span class="sd">          k_stim [BT_stim x N_pixels] - The filter for each pixel.</span>
</span><span id="CBEM_basic-407"><a href="#CBEM_basic-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-408"><a href="#CBEM_basic-408"><span class="linenos">408</span></a>
</span><span id="CBEM_basic-409"><a href="#CBEM_basic-409"><span class="linenos">409</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-410"><a href="#CBEM_basic-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span> <span class="o">@</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">cc</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span><span class="p">));</span>
</span><span id="CBEM_basic-411"><a href="#CBEM_basic-411"><span class="linenos">411</span></a>
</span><span id="CBEM_basic-412"><a href="#CBEM_basic-412"><span class="linenos">412</span></a>    <span class="k">def</span> <span class="nf">getSpikeHistoryFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-413"><a href="#CBEM_basic-413"><span class="linenos">413</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-414"><a href="#CBEM_basic-414"><span class="linenos">414</span></a><span class="sd">        Gets the full spike history filter (basis times weights).</span>
</span><span id="CBEM_basic-415"><a href="#CBEM_basic-415"><span class="linenos">415</span></a>
</span><span id="CBEM_basic-416"><a href="#CBEM_basic-416"><span class="linenos">416</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-417"><a href="#CBEM_basic-417"><span class="linenos">417</span></a><span class="sd">          h_spk [BT_hspk x 1] - The full spike history filter.</span>
</span><span id="CBEM_basic-418"><a href="#CBEM_basic-418"><span class="linenos">418</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-419"><a href="#CBEM_basic-419"><span class="linenos">419</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-420"><a href="#CBEM_basic-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">;</span>
</span><span id="CBEM_basic-421"><a href="#CBEM_basic-421"><span class="linenos">421</span></a>
</span><span id="CBEM_basic-422"><a href="#CBEM_basic-422"><span class="linenos">422</span></a>    <span class="c1"># simulate a set of spike trains given the currently set stimulus</span>
</span><span id="CBEM_basic-423"><a href="#CBEM_basic-423"><span class="linenos">423</span></a>    <span class="k">def</span> <span class="nf">simulateSpikeTrains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y_init</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">N</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic-424"><a href="#CBEM_basic-424"><span class="linenos">424</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic-425"><a href="#CBEM_basic-425"><span class="linenos">425</span></a><span class="sd">        Simulates a set of spike trains with the currently set stimulus. This can be really slow!</span>
</span><span id="CBEM_basic-426"><a href="#CBEM_basic-426"><span class="linenos">426</span></a><span class="sd">        This function requires an initial set of spikes to avoid dealing with edge effects of the spike history filter.</span>
</span><span id="CBEM_basic-427"><a href="#CBEM_basic-427"><span class="linenos">427</span></a>
</span><span id="CBEM_basic-428"><a href="#CBEM_basic-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic-429"><a href="#CBEM_basic-429"><span class="linenos">429</span></a><span class="sd">          Y_init:  [T_0 x (N or 1)] - A matrix of ones and zerosThe initial spike trains. T_0 should be less than T_stim</span>
</span><span id="CBEM_basic-430"><a href="#CBEM_basic-430"><span class="linenos">430</span></a><span class="sd">          N:       (positive integer) - The number of simulations: only use this if Y_init.shape[1] == 1 and you want more than one simulation.</span>
</span><span id="CBEM_basic-431"><a href="#CBEM_basic-431"><span class="linenos">431</span></a><span class="sd">                                             If N &gt; 1 and Y_init.shape[1] == 1, it uses the same initial spike train for all simulations.</span>
</span><span id="CBEM_basic-432"><a href="#CBEM_basic-432"><span class="linenos">432</span></a><span class="sd">                                                                 </span>
</span><span id="CBEM_basic-433"><a href="#CBEM_basic-433"><span class="linenos">433</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic-434"><a href="#CBEM_basic-434"><span class="linenos">434</span></a><span class="sd">          sps [T_stim x N] - A matrix of spikes for each of the N simulations. Spikes are either 1 or 0.</span>
</span><span id="CBEM_basic-435"><a href="#CBEM_basic-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic-436"><a href="#CBEM_basic-436"><span class="linenos">436</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic-437"><a href="#CBEM_basic-437"><span class="linenos">437</span></a>        <span class="n">Y_init</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic-438"><a href="#CBEM_basic-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic-439"><a href="#CBEM_basic-439"><span class="linenos">439</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="CBEM_basic-440"><a href="#CBEM_basic-440"><span class="linenos">440</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Invalid arguments for number of simulations&quot;</span>
</span><span id="CBEM_basic-441"><a href="#CBEM_basic-441"><span class="linenos">441</span></a>
</span><span id="CBEM_basic-442"><a href="#CBEM_basic-442"><span class="linenos">442</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># total simulation length</span>
</span><span id="CBEM_basic-443"><a href="#CBEM_basic-443"><span class="linenos">443</span></a>        <span class="n">T_0</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># initial seed length</span>
</span><span id="CBEM_basic-444"><a href="#CBEM_basic-444"><span class="linenos">444</span></a>        <span class="n">P_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="CBEM_basic-445"><a href="#CBEM_basic-445"><span class="linenos">445</span></a>        <span class="k">assert</span> <span class="n">T_0</span> <span class="o">&gt;</span> <span class="n">P_lin</span> <span class="ow">and</span> <span class="n">T_0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;initial spike train too short for bases&quot;</span>
</span><span id="CBEM_basic-446"><a href="#CBEM_basic-446"><span class="linenos">446</span></a>        <span class="k">assert</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no simulations requested&quot;</span>
</span><span id="CBEM_basic-447"><a href="#CBEM_basic-447"><span class="linenos">447</span></a>
</span><span id="CBEM_basic-448"><a href="#CBEM_basic-448"><span class="linenos">448</span></a>        <span class="c1"># sets up spikes</span>
</span><span id="CBEM_basic-449"><a href="#CBEM_basic-449"><span class="linenos">449</span></a>        <span class="n">sps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>
</span><span id="CBEM_basic-450"><a href="#CBEM_basic-450"><span class="linenos">450</span></a>        <span class="n">sps</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">at</span><span class="p">[:</span><span class="n">T_0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Y_init</span><span class="p">);</span>
</span><span id="CBEM_basic-451"><a href="#CBEM_basic-451"><span class="linenos">451</span></a>
</span><span id="CBEM_basic-452"><a href="#CBEM_basic-452"><span class="linenos">452</span></a>        <span class="c1"># gets voltage (in this model, it&#39;s determined by the stimulus. Would need a more complex function for spike-dependent conductances)</span>
</span><span id="CBEM_basic-453"><a href="#CBEM_basic-453"><span class="linenos">453</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">();</span>
</span><span id="CBEM_basic-454"><a href="#CBEM_basic-454"><span class="linenos">454</span></a>        <span class="n">h_spk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSpikeHistoryFilter</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic-455"><a href="#CBEM_basic-455"><span class="linenos">455</span></a>
</span><span id="CBEM_basic-456"><a href="#CBEM_basic-456"><span class="linenos">456</span></a>        <span class="c1"># random values for spike generation</span>
</span><span id="CBEM_basic-457"><a href="#CBEM_basic-457"><span class="linenos">457</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="CBEM_basic-458"><a href="#CBEM_basic-458"><span class="linenos">458</span></a>        <span class="n">rs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>
</span><span id="CBEM_basic-459"><a href="#CBEM_basic-459"><span class="linenos">459</span></a>
</span><span id="CBEM_basic-460"><a href="#CBEM_basic-460"><span class="linenos">460</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; simulations... (WARNING: This function can be painfully slow!)&quot;</span><span class="p">);</span>
</span><span id="CBEM_basic-461"><a href="#CBEM_basic-461"><span class="linenos">461</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_0 = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T_0</span><span class="p">));</span>
</span><span id="CBEM_basic-462"><a href="#CBEM_basic-462"><span class="linenos">462</span></a>        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T_0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
</span><span id="CBEM_basic-463"><a href="#CBEM_basic-463"><span class="linenos">463</span></a>            <span class="k">if</span> <span class="n">tt</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CBEM_basic-464"><a href="#CBEM_basic-464"><span class="linenos">464</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tt = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; / &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
</span><span id="CBEM_basic-465"><a href="#CBEM_basic-465"><span class="linenos">465</span></a>            <span class="c1"># gets spike history &amp; adds to voltage</span>
</span><span id="CBEM_basic-466"><a href="#CBEM_basic-466"><span class="linenos">466</span></a>            <span class="n">V_c</span> <span class="o">=</span> <span class="n">h_spk</span> <span class="o">@</span> <span class="n">sps</span><span class="p">[(</span><span class="n">tt</span><span class="o">-</span><span class="n">P_lin</span><span class="p">):</span><span class="n">tt</span><span class="p">,:];</span>
</span><span id="CBEM_basic-467"><a href="#CBEM_basic-467"><span class="linenos">467</span></a>            <span class="n">V_c</span> <span class="o">+=</span> <span class="n">V</span><span class="p">[</span><span class="n">tt</span><span class="p">];</span>
</span><span id="CBEM_basic-468"><a href="#CBEM_basic-468"><span class="linenos">468</span></a>
</span><span id="CBEM_basic-469"><a href="#CBEM_basic-469"><span class="linenos">469</span></a>            <span class="c1"># gets spike probability</span>
</span><span id="CBEM_basic-470"><a href="#CBEM_basic-470"><span class="linenos">470</span></a>            <span class="n">fr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">firingRateNonlinearity</span><span class="p">(</span><span class="n">V_c</span><span class="p">);</span>
</span><span id="CBEM_basic-471"><a href="#CBEM_basic-471"><span class="linenos">471</span></a>            <span class="n">p_1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fr</span><span class="p">));</span>
</span><span id="CBEM_basic-472"><a href="#CBEM_basic-472"><span class="linenos">472</span></a>            <span class="n">spiked</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="n">p_1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">();</span>
</span><span id="CBEM_basic-473"><a href="#CBEM_basic-473"><span class="linenos">473</span></a>
</span><span id="CBEM_basic-474"><a href="#CBEM_basic-474"><span class="linenos">474</span></a>            <span class="c1"># generates spike</span>
</span><span id="CBEM_basic-475"><a href="#CBEM_basic-475"><span class="linenos">475</span></a>            <span class="n">sps</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">spiked</span><span class="p">);</span>
</span><span id="CBEM_basic-476"><a href="#CBEM_basic-476"><span class="linenos">476</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">);</span>
</span><span id="CBEM_basic-477"><a href="#CBEM_basic-477"><span class="linenos">477</span></a>        <span class="k">return</span> <span class="n">sps</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>A basic implementation of the Conductance-based encoding model.
The model has three inputs: excitatory and inhibitory conductance (soft-rectified, affine function in the stimulus)
                            a linear spike history (not conductance-based)
The 'setObservations' sets up the data: current stimulus and spike train.</p>
</div>


                            <div id="CBEM_basic.__init__" class="classattr">
                                        <input id="CBEM_basic.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CBEM_basic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">binSize_ms</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">basis_conductance</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">basis_hspk</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CBEM_basic.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.__init__-60"><a href="#CBEM_basic.__init__-60"><span class="linenos"> 60</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">binSize_ms</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">basis_conductance</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basis_hspk</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CBEM_basic.__init__-61"><a href="#CBEM_basic.__init__-61"><span class="linenos"> 61</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.__init__-62"><a href="#CBEM_basic.__init__-62"><span class="linenos"> 62</span></a><span class="sd">        Initialize simple CBEM with one excitatory and one inhibitory conductance which share input.</span>
</span><span id="CBEM_basic.__init__-63"><a href="#CBEM_basic.__init__-63"><span class="linenos"> 63</span></a><span class="sd">        </span>
</span><span id="CBEM_basic.__init__-64"><a href="#CBEM_basic.__init__-64"><span class="linenos"> 64</span></a><span class="sd">        Note: bases are orthogonalized before fitting. Filter parameters will be in terms of the orthogonalized basis.</span>
</span><span id="CBEM_basic.__init__-65"><a href="#CBEM_basic.__init__-65"><span class="linenos"> 65</span></a>
</span><span id="CBEM_basic.__init__-66"><a href="#CBEM_basic.__init__-66"><span class="linenos"> 66</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.__init__-67"><a href="#CBEM_basic.__init__-67"><span class="linenos"> 67</span></a><span class="sd">          binSize_ms:           time bin size in milliseconds</span>
</span><span id="CBEM_basic.__init__-68"><a href="#CBEM_basic.__init__-68"><span class="linenos"> 68</span></a><span class="sd">          basis_conductance:    [BT_stim x P_stim], if None then getSimpleStimulusBasis(binSize_ms) -</span>
</span><span id="CBEM_basic.__init__-69"><a href="#CBEM_basic.__init__-69"><span class="linenos"> 69</span></a><span class="sd">                                Each column is a basis function for the conductances (conductances share a basis).</span>
</span><span id="CBEM_basic.__init__-70"><a href="#CBEM_basic.__init__-70"><span class="linenos"> 70</span></a><span class="sd">                                The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</span>
</span><span id="CBEM_basic.__init__-71"><a href="#CBEM_basic.__init__-71"><span class="linenos"> 71</span></a><span class="sd">          basis_hspk:           [BT_hspk x P_hspk], if None then getSimpleSpkHistBasis(binSize_ms) -</span>
</span><span id="CBEM_basic.__init__-72"><a href="#CBEM_basic.__init__-72"><span class="linenos"> 72</span></a><span class="sd">                                Each column is a basis function for the spike history.</span>
</span><span id="CBEM_basic.__init__-73"><a href="#CBEM_basic.__init__-73"><span class="linenos"> 73</span></a><span class="sd">                                The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</span>
</span><span id="CBEM_basic.__init__-74"><a href="#CBEM_basic.__init__-74"><span class="linenos"> 74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.__init__-75"><a href="#CBEM_basic.__init__-75"><span class="linenos"> 75</span></a>
</span><span id="CBEM_basic.__init__-76"><a href="#CBEM_basic.__init__-76"><span class="linenos"> 76</span></a>        <span class="c1"># discretization size</span>
</span><span id="CBEM_basic.__init__-77"><a href="#CBEM_basic.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span>    <span class="o">=</span> <span class="n">binSize_ms</span><span class="p">;</span>
</span><span id="CBEM_basic.__init__-78"><a href="#CBEM_basic.__init__-78"><span class="linenos"> 78</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bin size must be positive&quot;</span>
</span><span id="CBEM_basic.__init__-79"><a href="#CBEM_basic.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="CBEM_basic.__init__-80"><a href="#CBEM_basic.__init__-80"><span class="linenos"> 80</span></a>        <span class="c1"># setup bases for filters</span>
</span><span id="CBEM_basic.__init__-81"><a href="#CBEM_basic.__init__-81"><span class="linenos"> 81</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">basis_conductance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CBEM_basic.__init__-82"><a href="#CBEM_basic.__init__-82"><span class="linenos"> 82</span></a>            <span class="n">basis_conductance</span><span class="p">,</span><span class="n">tts</span> <span class="o">=</span> <span class="n">getSimpleStimulusBasis</span><span class="p">(</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="CBEM_basic.__init__-83"><a href="#CBEM_basic.__init__-83"><span class="linenos"> 83</span></a>            
</span><span id="CBEM_basic.__init__-84"><a href="#CBEM_basic.__init__-84"><span class="linenos"> 84</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">basis_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CBEM_basic.__init__-85"><a href="#CBEM_basic.__init__-85"><span class="linenos"> 85</span></a>            <span class="n">basis_hspk</span><span class="p">,</span><span class="n">tts</span> <span class="o">=</span> <span class="n">getSimpleSpkHistBasis</span><span class="p">(</span><span class="n">binSize_ms</span><span class="p">);</span>
</span><span id="CBEM_basic.__init__-86"><a href="#CBEM_basic.__init__-86"><span class="linenos"> 86</span></a>
</span><span id="CBEM_basic.__init__-87"><a href="#CBEM_basic.__init__-87"><span class="linenos"> 87</span></a>        <span class="k">assert</span> <span class="n">basis_conductance</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Basis cannot be more than 2 dimensions&quot;</span>
</span><span id="CBEM_basic.__init__-88"><a href="#CBEM_basic.__init__-88"><span class="linenos"> 88</span></a>        <span class="k">assert</span> <span class="n">basis_hspk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Basis cannot be more than 2 dimensions&quot;</span>
</span><span id="CBEM_basic.__init__-89"><a href="#CBEM_basic.__init__-89"><span class="linenos"> 89</span></a>
</span><span id="CBEM_basic.__init__-90"><a href="#CBEM_basic.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance_0</span> <span class="o">=</span> <span class="n">basis_conductance</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic.__init__-91"><a href="#CBEM_basic.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk_0</span>      <span class="o">=</span> <span class="n">basis_hspk</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic.__init__-92"><a href="#CBEM_basic.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">orth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance_0</span><span class="p">));</span>
</span><span id="CBEM_basic.__init__-93"><a href="#CBEM_basic.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span>        <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">orth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk_0</span> <span class="p">));</span>
</span><span id="CBEM_basic.__init__-94"><a href="#CBEM_basic.__init__-94"><span class="linenos"> 94</span></a>
</span><span id="CBEM_basic.__init__-95"><a href="#CBEM_basic.__init__-95"><span class="linenos"> 95</span></a>        <span class="c1"># setup LIF parameters </span>
</span><span id="CBEM_basic.__init__-96"><a href="#CBEM_basic.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">E_input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">]);</span> <span class="c1"># mV</span>
</span><span id="CBEM_basic.__init__-97"><a href="#CBEM_basic.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span> <span class="c1"># mV</span>
</span><span id="CBEM_basic.__init__-98"><a href="#CBEM_basic.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">g_l</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> 
</span><span id="CBEM_basic.__init__-99"><a href="#CBEM_basic.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span><span class="p">;</span> <span class="c1"># initial voltage</span>
</span><span id="CBEM_basic.__init__-100"><a href="#CBEM_basic.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">53</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span> <span class="p">:</span> <span class="mf">1.67</span><span class="p">};</span> <span class="c1"># &quot;beta&quot; : 1.67 or could be 1/0.45?</span>
</span><span id="CBEM_basic.__init__-101"><a href="#CBEM_basic.__init__-101"><span class="linenos">101</span></a>
</span><span id="CBEM_basic.__init__-102"><a href="#CBEM_basic.__init__-102"><span class="linenos">102</span></a>        <span class="c1"># no stimulus set yet - won&#39;t run model</span>
</span><span id="CBEM_basic.__init__-103"><a href="#CBEM_basic.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic.__init__-104"><a href="#CBEM_basic.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic.__init__-105"><a href="#CBEM_basic.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic.__init__-106"><a href="#CBEM_basic.__init__-106"><span class="linenos">106</span></a>
</span><span id="CBEM_basic.__init__-107"><a href="#CBEM_basic.__init__-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic.__init__-108"><a href="#CBEM_basic.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
</span><span id="CBEM_basic.__init__-109"><a href="#CBEM_basic.__init__-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize simple CBEM with one excitatory and one inhibitory conductance which share input.</p>

<p>Note: bases are orthogonalized before fitting. Filter parameters will be in terms of the orthogonalized basis.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>binSize_ms:</strong>            time bin size in milliseconds</li>
<li><strong>basis_conductance:</strong>     [BT_stim x P_stim], if None then getSimpleStimulusBasis(binSize_ms) -
Each column is a basis function for the conductances (conductances share a basis).
The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</li>
<li><strong>basis_hspk:</strong>            [BT_hspk x P_hspk], if None then getSimpleSpkHistBasis(binSize_ms) -
Each column is a basis function for the spike history.
The basis is assumed to be causal: basis_conductance[0,:] are the basis weights for the previous time bin.</li>
</ul>
</div>


                            </div>
                            <div id="CBEM_basic.B_cond" class="classattr">
                                <div class="attr variable">
            <span class="name">B_cond</span>

        
    </div>
    <a class="headerlink" href="#CBEM_basic.B_cond"></a>
    
            <div class="docstring"><p>jnp.ndarray: [(BT_stim + 1) x 2] - The conductance filters and baseline parameters.</p>
</div>


                            </div>
                            <div id="CBEM_basic.B_hspk" class="classattr">
                                <div class="attr variable">
            <span class="name">B_hspk</span>

        
    </div>
    <a class="headerlink" href="#CBEM_basic.B_hspk"></a>
    
            <div class="docstring"><p>jnp.ndarray: [BT_hspk x 1] - The spike history filter parameters.</p>
</div>


                            </div>
                            <div id="CBEM_basic.setObservations" class="classattr">
                                        <input id="CBEM_basic.setObservations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setObservations</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">Stimulus</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">spkTimes_bins</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">window</span><span class="p">:</span> <span class="nb">range</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.setObservations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.setObservations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.setObservations-137"><a href="#CBEM_basic.setObservations-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="nf">setObservations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Stimulus</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">spkTimes_bins</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">window</span> <span class="p">:</span> <span class="nb">range</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.setObservations-138"><a href="#CBEM_basic.setObservations-138"><span class="linenos">138</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.setObservations-139"><a href="#CBEM_basic.setObservations-139"><span class="linenos">139</span></a><span class="sd">        Initializes the stimulus and spike train observation for this neuron.</span>
</span><span id="CBEM_basic.setObservations-140"><a href="#CBEM_basic.setObservations-140"><span class="linenos">140</span></a><span class="sd">        This assumes only one spike per bin is possible.</span>
</span><span id="CBEM_basic.setObservations-141"><a href="#CBEM_basic.setObservations-141"><span class="linenos">141</span></a>
</span><span id="CBEM_basic.setObservations-142"><a href="#CBEM_basic.setObservations-142"><span class="linenos">142</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.setObservations-143"><a href="#CBEM_basic.setObservations-143"><span class="linenos">143</span></a><span class="sd">          Stimulus:         [T_stim x number of pixels] - Pixels are treated independently</span>
</span><span id="CBEM_basic.setObservations-144"><a href="#CBEM_basic.setObservations-144"><span class="linenos">144</span></a><span class="sd">          spkTimes_bins:    List of the spike times in bins.</span>
</span><span id="CBEM_basic.setObservations-145"><a href="#CBEM_basic.setObservations-145"><span class="linenos">145</span></a><span class="sd">          window:           The window of stimulus and spikes to fit. This input allows you to cut out the first </span>
</span><span id="CBEM_basic.setObservations-146"><a href="#CBEM_basic.setObservations-146"><span class="linenos">146</span></a><span class="sd">                            part of the given spike train to avoid edge effects for spike history or stimulus.</span>
</span><span id="CBEM_basic.setObservations-147"><a href="#CBEM_basic.setObservations-147"><span class="linenos">147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.setObservations-148"><a href="#CBEM_basic.setObservations-148"><span class="linenos">148</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
</span><span id="CBEM_basic.setObservations-149"><a href="#CBEM_basic.setObservations-149"><span class="linenos">149</span></a>        <span class="c1"># get the conductance desgin matrix(same for both conductances)</span>
</span><span id="CBEM_basic.setObservations-150"><a href="#CBEM_basic.setObservations-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">convolveStimulusWithBasis</span><span class="p">(</span><span class="n">Stimulus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="p">)[</span><span class="n">window</span><span class="p">,:]);</span>
</span><span id="CBEM_basic.setObservations-151"><a href="#CBEM_basic.setObservations-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
</span><span id="CBEM_basic.setObservations-152"><a href="#CBEM_basic.setObservations-152"><span class="linenos">152</span></a>
</span><span id="CBEM_basic.setObservations-153"><a href="#CBEM_basic.setObservations-153"><span class="linenos">153</span></a>        <span class="c1"># get spike history</span>
</span><span id="CBEM_basic.setObservations-154"><a href="#CBEM_basic.setObservations-154"><span class="linenos">154</span></a>        <span class="n">X_l</span><span class="p">,</span> <span class="n">Y_0</span>      <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">convolveSpksWithBasis</span><span class="p">(</span><span class="n">spkTimes_bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="p">,</span> <span class="n">Stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="CBEM_basic.setObservations-155"><a href="#CBEM_basic.setObservations-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span>    <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_l</span><span class="p">[</span><span class="n">window</span><span class="p">,:]);</span>
</span><span id="CBEM_basic.setObservations-156"><a href="#CBEM_basic.setObservations-156"><span class="linenos">156</span></a>
</span><span id="CBEM_basic.setObservations-157"><a href="#CBEM_basic.setObservations-157"><span class="linenos">157</span></a>        <span class="c1"># get spike times within the current window</span>
</span><span id="CBEM_basic.setObservations-158"><a href="#CBEM_basic.setObservations-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span>              <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_0</span><span class="p">[</span><span class="n">window</span><span class="p">]);</span> <span class="c1"># vectorized spike times</span>
</span><span id="CBEM_basic.setObservations-159"><a href="#CBEM_basic.setObservations-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">spkTimes_bins</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span> 
</span><span id="CBEM_basic.setObservations-160"><a href="#CBEM_basic.setObservations-160"><span class="linenos">160</span></a>        
</span><span id="CBEM_basic.setObservations-161"><a href="#CBEM_basic.setObservations-161"><span class="linenos">161</span></a>        <span class="c1"># setup empty parameters</span>
</span><span id="CBEM_basic.setObservations-162"><a href="#CBEM_basic.setObservations-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span><span id="CBEM_basic.setObservations-163"><a href="#CBEM_basic.setObservations-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the stimulus and spike train observation for this neuron.
This assumes only one spike per bin is possible.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>Stimulus:</strong>          [T_stim x number of pixels] - Pixels are treated independently</li>
<li><strong>spkTimes_bins:</strong>     List of the spike times in bins.</li>
<li><strong>window:</strong>            The window of stimulus and spikes to fit. This input allows you to cut out the first 
part of the given spike train to avoid edge effects for spike history or stimulus.</li>
</ul>
</div>


                            </div>
                            <div id="CBEM_basic.getConductances" class="classattr">
                                        <input id="CBEM_basic.getConductances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getConductances</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B_cond</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getConductances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getConductances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getConductances-166"><a href="#CBEM_basic.getConductances-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">getConductances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getConductances-167"><a href="#CBEM_basic.getConductances-167"><span class="linenos">167</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getConductances-168"><a href="#CBEM_basic.getConductances-168"><span class="linenos">168</span></a><span class="sd">        Computes the conductances given the conductance filter parameters for the current stimulus.</span>
</span><span id="CBEM_basic.getConductances-169"><a href="#CBEM_basic.getConductances-169"><span class="linenos">169</span></a><span class="sd">        The conductance nonlinearity is a soft-rectifier.</span>
</span><span id="CBEM_basic.getConductances-170"><a href="#CBEM_basic.getConductances-170"><span class="linenos">170</span></a>
</span><span id="CBEM_basic.getConductances-171"><a href="#CBEM_basic.getConductances-171"><span class="linenos">171</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.getConductances-172"><a href="#CBEM_basic.getConductances-172"><span class="linenos">172</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.get_B_cond() -</span>
</span><span id="CBEM_basic.getConductances-173"><a href="#CBEM_basic.getConductances-173"><span class="linenos">173</span></a><span class="sd">                        Parameters of the two conductance filters as weights on the basis functions. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.getConductances-174"><a href="#CBEM_basic.getConductances-174"><span class="linenos">174</span></a><span class="sd">                        The last entry is the basline term.</span>
</span><span id="CBEM_basic.getConductances-175"><a href="#CBEM_basic.getConductances-175"><span class="linenos">175</span></a><span class="sd">        </span>
</span><span id="CBEM_basic.getConductances-176"><a href="#CBEM_basic.getConductances-176"><span class="linenos">176</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.getConductances-177"><a href="#CBEM_basic.getConductances-177"><span class="linenos">177</span></a><span class="sd">          gs  [T_stim x 2] - first column is excitatory conductance, second inhibitory</span>
</span><span id="CBEM_basic.getConductances-178"><a href="#CBEM_basic.getConductances-178"><span class="linenos">178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getConductances-179"><a href="#CBEM_basic.getConductances-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getConductances-180"><a href="#CBEM_basic.getConductances-180"><span class="linenos">180</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic.getConductances-181"><a href="#CBEM_basic.getConductances-181"><span class="linenos">181</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Stimulus not initialized!&quot;</span>
</span><span id="CBEM_basic.getConductances-182"><a href="#CBEM_basic.getConductances-182"><span class="linenos">182</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B_cond</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">),</span> <span class="s2">&quot;Conductance parameters not correct shape&quot;</span>
</span><span id="CBEM_basic.getConductances-183"><a href="#CBEM_basic.getConductances-183"><span class="linenos">183</span></a>
</span><span id="CBEM_basic.getConductances-184"><a href="#CBEM_basic.getConductances-184"><span class="linenos">184</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span> <span class="o">@</span> <span class="n">B_cond</span><span class="p">);</span>
</span></pre></div>


            <div class="docstring"><p>Computes the conductances given the conductance filter parameters for the current stimulus.
The conductance nonlinearity is a soft-rectifier.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B_cond:</strong>    [(P_stim + 1) x 2], if None then self.get_B_cond() -
Parameters of the two conductance filters as weights on the basis functions. First column is excitatory, second inhibitory.
The last entry is the basline term.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>gs  [T_stim x 2] - first column is excitatory conductance, second inhibitory</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.getVoltage" class="classattr">
                                        <input id="CBEM_basic.getVoltage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getVoltage</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B_cond</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getVoltage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getVoltage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getVoltage-186"><a href="#CBEM_basic.getVoltage-186"><span class="linenos">186</span></a>    <span class="k">def</span> <span class="nf">getVoltage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getVoltage-187"><a href="#CBEM_basic.getVoltage-187"><span class="linenos">187</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getVoltage-188"><a href="#CBEM_basic.getVoltage-188"><span class="linenos">188</span></a><span class="sd">        Computes the voltage given the conductance parameters for the set stimulus.</span>
</span><span id="CBEM_basic.getVoltage-189"><a href="#CBEM_basic.getVoltage-189"><span class="linenos">189</span></a><span class="sd">        </span>
</span><span id="CBEM_basic.getVoltage-190"><a href="#CBEM_basic.getVoltage-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.getVoltage-191"><a href="#CBEM_basic.getVoltage-191"><span class="linenos">191</span></a><span class="sd">          B_cond:  [(P_stim + 1) x 2], if None then  self.get_B_cond() -</span>
</span><span id="CBEM_basic.getVoltage-192"><a href="#CBEM_basic.getVoltage-192"><span class="linenos">192</span></a><span class="sd">                        Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.getVoltage-193"><a href="#CBEM_basic.getVoltage-193"><span class="linenos">193</span></a><span class="sd">                        The last entry is the basline term.</span>
</span><span id="CBEM_basic.getVoltage-194"><a href="#CBEM_basic.getVoltage-194"><span class="linenos">194</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic.getVoltage-195"><a href="#CBEM_basic.getVoltage-195"><span class="linenos">195</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.getVoltage-196"><a href="#CBEM_basic.getVoltage-196"><span class="linenos">196</span></a><span class="sd">          V [T_stim] - the solved voltage in millivolts</span>
</span><span id="CBEM_basic.getVoltage-197"><a href="#CBEM_basic.getVoltage-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getVoltage-198"><a href="#CBEM_basic.getVoltage-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getVoltage-199"><a href="#CBEM_basic.getVoltage-199"><span class="linenos">199</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic.getVoltage-200"><a href="#CBEM_basic.getVoltage-200"><span class="linenos">200</span></a>
</span><span id="CBEM_basic.getVoltage-201"><a href="#CBEM_basic.getVoltage-201"><span class="linenos">201</span></a>        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConductances</span><span class="p">(</span><span class="n">B_cond</span><span class="p">);</span>
</span><span id="CBEM_basic.getVoltage-202"><a href="#CBEM_basic.getVoltage-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">)(</span><span class="n">gs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="p">);</span>
</span></pre></div>


            <div class="docstring"><p>Computes the voltage given the conductance parameters for the set stimulus.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B_cond:</strong>   [(P_stim + 1) x 2], if None then  self.get_B_cond() -
Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.
The last entry is the basline term.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>V [T_stim] - the solved voltage in millivolts</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.firingRateNonlinearity" class="classattr">
                                        <input id="CBEM_basic.firingRateNonlinearity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">firingRateNonlinearity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">V_tot</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.firingRateNonlinearity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.firingRateNonlinearity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.firingRateNonlinearity-204"><a href="#CBEM_basic.firingRateNonlinearity-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">firingRateNonlinearity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V_tot</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.firingRateNonlinearity-205"><a href="#CBEM_basic.firingRateNonlinearity-205"><span class="linenos">205</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.firingRateNonlinearity-206"><a href="#CBEM_basic.firingRateNonlinearity-206"><span class="linenos">206</span></a><span class="sd">        Computes the firing rate nonlinearity on the given total voltage.</span>
</span><span id="CBEM_basic.firingRateNonlinearity-207"><a href="#CBEM_basic.firingRateNonlinearity-207"><span class="linenos">207</span></a><span class="sd">        The nonlinearity is alpha * softplus((V_tot - mu)/beta)</span>
</span><span id="CBEM_basic.firingRateNonlinearity-208"><a href="#CBEM_basic.firingRateNonlinearity-208"><span class="linenos">208</span></a>
</span><span id="CBEM_basic.firingRateNonlinearity-209"><a href="#CBEM_basic.firingRateNonlinearity-209"><span class="linenos">209</span></a><span class="sd">        - self.frNonlinearity holds the parameters alpha, beta, and mu</span>
</span><span id="CBEM_basic.firingRateNonlinearity-210"><a href="#CBEM_basic.firingRateNonlinearity-210"><span class="linenos">210</span></a>
</span><span id="CBEM_basic.firingRateNonlinearity-211"><a href="#CBEM_basic.firingRateNonlinearity-211"><span class="linenos">211</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.firingRateNonlinearity-212"><a href="#CBEM_basic.firingRateNonlinearity-212"><span class="linenos">212</span></a><span class="sd">          V_tot:    [T] - The total voltage terms.</span>
</span><span id="CBEM_basic.firingRateNonlinearity-213"><a href="#CBEM_basic.firingRateNonlinearity-213"><span class="linenos">213</span></a><span class="sd">                    Total voltage is the membrane potential from the membrane potential equation plus spike history terms.</span>
</span><span id="CBEM_basic.firingRateNonlinearity-214"><a href="#CBEM_basic.firingRateNonlinearity-214"><span class="linenos">214</span></a>
</span><span id="CBEM_basic.firingRateNonlinearity-215"><a href="#CBEM_basic.firingRateNonlinearity-215"><span class="linenos">215</span></a><span class="sd">        Returns:              </span>
</span><span id="CBEM_basic.firingRateNonlinearity-216"><a href="#CBEM_basic.firingRateNonlinearity-216"><span class="linenos">216</span></a><span class="sd">          spikeRate [T] - the firing rate for each term in V_tot</span>
</span><span id="CBEM_basic.firingRateNonlinearity-217"><a href="#CBEM_basic.firingRateNonlinearity-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.firingRateNonlinearity-218"><a href="#CBEM_basic.firingRateNonlinearity-218"><span class="linenos">218</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">((</span><span class="n">V_tot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">])</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frNonlinearity</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]);</span>
</span></pre></div>


            <div class="docstring"><p>Computes the firing rate nonlinearity on the given total voltage.
The nonlinearity is alpha * softplus((V_tot - mu)/beta)</p>

<ul>
<li>self.frNonlinearity holds the parameters alpha, beta, and mu</li>
</ul>

<h6 id="args">Args</h6>

<ul>
<li><strong>V_tot:</strong>     [T] - The total voltage terms.
Total voltage is the membrane potential from the membrane potential equation plus spike history terms.</li>
</ul>

<p>Returns: <br />
  spikeRate [T] - the firing rate for each term in V_tot</p>
</div>


                            </div>
                            <div id="CBEM_basic.getSpikeHistory" class="classattr">
                                        <input id="CBEM_basic.getSpikeHistory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getSpikeHistory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B_hspk</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getSpikeHistory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getSpikeHistory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getSpikeHistory-220"><a href="#CBEM_basic.getSpikeHistory-220"><span class="linenos">220</span></a>    <span class="k">def</span> <span class="nf">getSpikeHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getSpikeHistory-221"><a href="#CBEM_basic.getSpikeHistory-221"><span class="linenos">221</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getSpikeHistory-222"><a href="#CBEM_basic.getSpikeHistory-222"><span class="linenos">222</span></a><span class="sd">        Computes the spike history given the parameters for the set spike train. (A simple linear function)</span>
</span><span id="CBEM_basic.getSpikeHistory-223"><a href="#CBEM_basic.getSpikeHistory-223"><span class="linenos">223</span></a>
</span><span id="CBEM_basic.getSpikeHistory-224"><a href="#CBEM_basic.getSpikeHistory-224"><span class="linenos">224</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.getSpikeHistory-225"><a href="#CBEM_basic.getSpikeHistory-225"><span class="linenos">225</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic.getSpikeHistory-226"><a href="#CBEM_basic.getSpikeHistory-226"><span class="linenos">226</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic.getSpikeHistory-227"><a href="#CBEM_basic.getSpikeHistory-227"><span class="linenos">227</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.getSpikeHistory-228"><a href="#CBEM_basic.getSpikeHistory-228"><span class="linenos">228</span></a><span class="sd">          hspk  [T_stim] - the linear spike history</span>
</span><span id="CBEM_basic.getSpikeHistory-229"><a href="#CBEM_basic.getSpikeHistory-229"><span class="linenos">229</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getSpikeHistory-230"><a href="#CBEM_basic.getSpikeHistory-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getSpikeHistory-231"><a href="#CBEM_basic.getSpikeHistory-231"><span class="linenos">231</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic.getSpikeHistory-232"><a href="#CBEM_basic.getSpikeHistory-232"><span class="linenos">232</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B_hspk</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">),</span> <span class="s2">&quot;Linear parameters not correct shape&quot;</span>
</span><span id="CBEM_basic.getSpikeHistory-233"><a href="#CBEM_basic.getSpikeHistory-233"><span class="linenos">233</span></a>
</span><span id="CBEM_basic.getSpikeHistory-234"><a href="#CBEM_basic.getSpikeHistory-234"><span class="linenos">234</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lin</span> <span class="o">@</span> <span class="n">B_hspk</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>Computes the spike history given the parameters for the set spike train. (A simple linear function)</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B_hspk:</strong>    [P_hspk x 1], if None then self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>hspk  [T_stim] - the linear spike history</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.getSpikeRate" class="classattr">
                                        <input id="CBEM_basic.getSpikeRate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getSpikeRate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B_cond</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">B_hspk</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getSpikeRate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getSpikeRate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getSpikeRate-236"><a href="#CBEM_basic.getSpikeRate-236"><span class="linenos">236</span></a>    <span class="k">def</span> <span class="nf">getSpikeRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span>  <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span>  <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getSpikeRate-237"><a href="#CBEM_basic.getSpikeRate-237"><span class="linenos">237</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getSpikeRate-238"><a href="#CBEM_basic.getSpikeRate-238"><span class="linenos">238</span></a><span class="sd">        Computes the spike rate at each time given the conductance and spike history parameters for the set stimulus &amp; spike history.</span>
</span><span id="CBEM_basic.getSpikeRate-239"><a href="#CBEM_basic.getSpikeRate-239"><span class="linenos">239</span></a>
</span><span id="CBEM_basic.getSpikeRate-240"><a href="#CBEM_basic.getSpikeRate-240"><span class="linenos">240</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.getSpikeRate-241"><a href="#CBEM_basic.getSpikeRate-241"><span class="linenos">241</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then  self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.getSpikeRate-242"><a href="#CBEM_basic.getSpikeRate-242"><span class="linenos">242</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic.getSpikeRate-243"><a href="#CBEM_basic.getSpikeRate-243"><span class="linenos">243</span></a>
</span><span id="CBEM_basic.getSpikeRate-244"><a href="#CBEM_basic.getSpikeRate-244"><span class="linenos">244</span></a><span class="sd">        Returns            </span>
</span><span id="CBEM_basic.getSpikeRate-245"><a href="#CBEM_basic.getSpikeRate-245"><span class="linenos">245</span></a><span class="sd">          spikeRate [T_stim] - the firing rate in each bin in units of spikes/sec</span>
</span><span id="CBEM_basic.getSpikeRate-246"><a href="#CBEM_basic.getSpikeRate-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getSpikeRate-247"><a href="#CBEM_basic.getSpikeRate-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getSpikeRate-248"><a href="#CBEM_basic.getSpikeRate-248"><span class="linenos">248</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic.getSpikeRate-249"><a href="#CBEM_basic.getSpikeRate-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getSpikeRate-250"><a href="#CBEM_basic.getSpikeRate-250"><span class="linenos">250</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic.getSpikeRate-251"><a href="#CBEM_basic.getSpikeRate-251"><span class="linenos">251</span></a>
</span><span id="CBEM_basic.getSpikeRate-252"><a href="#CBEM_basic.getSpikeRate-252"><span class="linenos">252</span></a>        <span class="n">V_tot</span>  <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">(</span><span class="n">B_cond</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpikeHistory</span><span class="p">(</span><span class="n">B_hspk</span><span class="p">);</span> <span class="c1"># add membrane voltage and spike history </span>
</span><span id="CBEM_basic.getSpikeRate-253"><a href="#CBEM_basic.getSpikeRate-253"><span class="linenos">253</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">firingRateNonlinearity</span><span class="p">(</span><span class="n">V_tot</span><span class="p">);</span> <span class="c1"># pass through transfer function</span>
</span></pre></div>


            <div class="docstring"><p>Computes the spike rate at each time given the conductance and spike history parameters for the set stimulus &amp; spike history.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B_cond:</strong>    [(P_stim + 1) x 2], if None then  self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</li>
<li><strong>B_hspk:</strong>    [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</li>
</ul>

<p>Returns <br />
  spikeRate [T_stim] - the firing rate in each bin in units of spikes/sec</p>
</div>


                            </div>
                            <div id="CBEM_basic.getLogLike" class="classattr">
                                        <input id="CBEM_basic.getLogLike-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getLogLike</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B_cond</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">B_hspk</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getLogLike-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getLogLike"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getLogLike-256"><a href="#CBEM_basic.getLogLike-256"><span class="linenos">256</span></a>    <span class="k">def</span> <span class="nf">getLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getLogLike-257"><a href="#CBEM_basic.getLogLike-257"><span class="linenos">257</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getLogLike-258"><a href="#CBEM_basic.getLogLike-258"><span class="linenos">258</span></a><span class="sd">        Computes the log likelihood at each time bin given the conductance and spike history parameters for the set stimulus &amp; spike history.</span>
</span><span id="CBEM_basic.getLogLike-259"><a href="#CBEM_basic.getLogLike-259"><span class="linenos">259</span></a><span class="sd">        This function uses a truncated Poisson likelihood. That is, Poisson(0 | rate) for bins without a spike and</span>
</span><span id="CBEM_basic.getLogLike-260"><a href="#CBEM_basic.getLogLike-260"><span class="linenos">260</span></a><span class="sd">                                                                 (1-Poisson(0 | rate)) for bins with a spike.</span>
</span><span id="CBEM_basic.getLogLike-261"><a href="#CBEM_basic.getLogLike-261"><span class="linenos">261</span></a>
</span><span id="CBEM_basic.getLogLike-262"><a href="#CBEM_basic.getLogLike-262"><span class="linenos">262</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.getLogLike-263"><a href="#CBEM_basic.getLogLike-263"><span class="linenos">263</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.getLogLike-264"><a href="#CBEM_basic.getLogLike-264"><span class="linenos">264</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic.getLogLike-265"><a href="#CBEM_basic.getLogLike-265"><span class="linenos">265</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic.getLogLike-266"><a href="#CBEM_basic.getLogLike-266"><span class="linenos">266</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.getLogLike-267"><a href="#CBEM_basic.getLogLike-267"><span class="linenos">267</span></a><span class="sd">          ll_bins [T_stim] - the log likelihood of the observation (a spike or no spike) at each bin.</span>
</span><span id="CBEM_basic.getLogLike-268"><a href="#CBEM_basic.getLogLike-268"><span class="linenos">268</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getLogLike-269"><a href="#CBEM_basic.getLogLike-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getLogLike-270"><a href="#CBEM_basic.getLogLike-270"><span class="linenos">270</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic.getLogLike-271"><a href="#CBEM_basic.getLogLike-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.getLogLike-272"><a href="#CBEM_basic.getLogLike-272"><span class="linenos">272</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic.getLogLike-273"><a href="#CBEM_basic.getLogLike-273"><span class="linenos">273</span></a>
</span><span id="CBEM_basic.getLogLike-274"><a href="#CBEM_basic.getLogLike-274"><span class="linenos">274</span></a>        <span class="n">ll_bins</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpikeRate</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">);</span>
</span><span id="CBEM_basic.getLogLike-275"><a href="#CBEM_basic.getLogLike-275"><span class="linenos">275</span></a>        <span class="n">ll_bins</span> <span class="o">=</span> <span class="n">ll_bins</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ll_bins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spkTimes_bins</span><span class="p">])));</span>
</span><span id="CBEM_basic.getLogLike-276"><a href="#CBEM_basic.getLogLike-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="n">ll_bins</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>Computes the log likelihood at each time bin given the conductance and spike history parameters for the set stimulus &amp; spike history.
This function uses a truncated Poisson likelihood. That is, Poisson(0 | rate) for bins without a spike and
                                                         (1-Poisson(0 | rate)) for bins with a spike.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B_cond:</strong>    [(P_stim + 1) x 2], if None then self.get_B_cond() - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</li>
<li><strong>B_hspk:</strong>    [P_hspk x 1], if None then  self.get_B_hspk() - Parameters of the spike history filter as weights on the basis functions.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>ll_bins [T_stim] - the log likelihood of the observation (a spike or no spike) at each bin.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.randomizeParameters" class="classattr">
                                        <input id="CBEM_basic.randomizeParameters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">randomizeParameters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">offset_term_mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">std_cond</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">std_lin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.randomizeParameters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.randomizeParameters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.randomizeParameters-279"><a href="#CBEM_basic.randomizeParameters-279"><span class="linenos">279</span></a>    <span class="k">def</span> <span class="nf">randomizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset_term_mean</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">std_cond</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">std_lin</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.randomizeParameters-280"><a href="#CBEM_basic.randomizeParameters-280"><span class="linenos">280</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.randomizeParameters-281"><a href="#CBEM_basic.randomizeParameters-281"><span class="linenos">281</span></a><span class="sd">        Sets the parameters of the model using i.i.d. normal draws.</span>
</span><span id="CBEM_basic.randomizeParameters-282"><a href="#CBEM_basic.randomizeParameters-282"><span class="linenos">282</span></a><span class="sd">        All filter weights are drawn with mean 0.</span>
</span><span id="CBEM_basic.randomizeParameters-283"><a href="#CBEM_basic.randomizeParameters-283"><span class="linenos">283</span></a>
</span><span id="CBEM_basic.randomizeParameters-284"><a href="#CBEM_basic.randomizeParameters-284"><span class="linenos">284</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.randomizeParameters-285"><a href="#CBEM_basic.randomizeParameters-285"><span class="linenos">285</span></a><span class="sd">          offset_term_mean: Mean of the baseline term of the conductances. This probably should be positive.</span>
</span><span id="CBEM_basic.randomizeParameters-286"><a href="#CBEM_basic.randomizeParameters-286"><span class="linenos">286</span></a><span class="sd">          std_cond:         Standard deviation of the conductance parameters.</span>
</span><span id="CBEM_basic.randomizeParameters-287"><a href="#CBEM_basic.randomizeParameters-287"><span class="linenos">287</span></a><span class="sd">          std_lin:          Standard deviation of the spike history parameters.</span>
</span><span id="CBEM_basic.randomizeParameters-288"><a href="#CBEM_basic.randomizeParameters-288"><span class="linenos">288</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic.randomizeParameters-289"><a href="#CBEM_basic.randomizeParameters-289"><span class="linenos">289</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.randomizeParameters-290"><a href="#CBEM_basic.randomizeParameters-290"><span class="linenos">290</span></a><span class="sd">          A tuple (B_cond, B_hspk)</span>
</span><span id="CBEM_basic.randomizeParameters-291"><a href="#CBEM_basic.randomizeParameters-291"><span class="linenos">291</span></a>
</span><span id="CBEM_basic.randomizeParameters-292"><a href="#CBEM_basic.randomizeParameters-292"><span class="linenos">292</span></a><span class="sd">            B_cond: [(P_stim + 1) x 2] - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.randomizeParameters-293"><a href="#CBEM_basic.randomizeParameters-293"><span class="linenos">293</span></a>
</span><span id="CBEM_basic.randomizeParameters-294"><a href="#CBEM_basic.randomizeParameters-294"><span class="linenos">294</span></a><span class="sd">            B_hspk:  [P_hspk x 1] - Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic.randomizeParameters-295"><a href="#CBEM_basic.randomizeParameters-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.randomizeParameters-296"><a href="#CBEM_basic.randomizeParameters-296"><span class="linenos">296</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.randomizeParameters-297"><a href="#CBEM_basic.randomizeParameters-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std_cond</span><span class="p">);</span>
</span><span id="CBEM_basic.randomizeParameters-298"><a href="#CBEM_basic.randomizeParameters-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std_lin</span><span class="p">);</span>
</span><span id="CBEM_basic.randomizeParameters-299"><a href="#CBEM_basic.randomizeParameters-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">offset_term_mean</span><span class="p">);</span>
</span><span id="CBEM_basic.randomizeParameters-300"><a href="#CBEM_basic.randomizeParameters-300"><span class="linenos">300</span></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">);</span>
</span></pre></div>


            <div class="docstring"><p>Sets the parameters of the model using i.i.d. normal draws.
All filter weights are drawn with mean 0.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>offset_term_mean:</strong>  Mean of the baseline term of the conductances. This probably should be positive.</li>
<li><strong>std_cond:</strong>          Standard deviation of the conductance parameters.</li>
<li><strong>std_lin:</strong>           Standard deviation of the spike history parameters.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A tuple (B_cond, B_hspk)</p>
  
  <p>B_cond: [(P_stim + 1) x 2] - Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</p>
  
  <p>B_hspk:  [P_hspk x 1] - Parameters of the spike history filter as weights on the basis functions.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.vectorizeParameters" class="classattr">
                                        <input id="CBEM_basic.vectorizeParameters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">vectorizeParameters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B_cond</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">B_hspk</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.vectorizeParameters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.vectorizeParameters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.vectorizeParameters-303"><a href="#CBEM_basic.vectorizeParameters-303"><span class="linenos">303</span></a>    <span class="k">def</span> <span class="nf">vectorizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_cond</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">B_hspk</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.vectorizeParameters-304"><a href="#CBEM_basic.vectorizeParameters-304"><span class="linenos">304</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.vectorizeParameters-305"><a href="#CBEM_basic.vectorizeParameters-305"><span class="linenos">305</span></a><span class="sd">        Flatens the parameters into a vector for optimization.</span>
</span><span id="CBEM_basic.vectorizeParameters-306"><a href="#CBEM_basic.vectorizeParameters-306"><span class="linenos">306</span></a>
</span><span id="CBEM_basic.vectorizeParameters-307"><a href="#CBEM_basic.vectorizeParameters-307"><span class="linenos">307</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.vectorizeParameters-308"><a href="#CBEM_basic.vectorizeParameters-308"><span class="linenos">308</span></a><span class="sd">          B_cond:   [(P_stim + 1) x 2], if None then self.B_cond -</span>
</span><span id="CBEM_basic.vectorizeParameters-309"><a href="#CBEM_basic.vectorizeParameters-309"><span class="linenos">309</span></a><span class="sd">                    Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.vectorizeParameters-310"><a href="#CBEM_basic.vectorizeParameters-310"><span class="linenos">310</span></a><span class="sd">          B_hspk:   [P_hspk x 1], if None then self.B_hspk -</span>
</span><span id="CBEM_basic.vectorizeParameters-311"><a href="#CBEM_basic.vectorizeParameters-311"><span class="linenos">311</span></a><span class="sd">                    Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic.vectorizeParameters-312"><a href="#CBEM_basic.vectorizeParameters-312"><span class="linenos">312</span></a><span class="sd">                    The last entry is the basline term.</span>
</span><span id="CBEM_basic.vectorizeParameters-313"><a href="#CBEM_basic.vectorizeParameters-313"><span class="linenos">313</span></a><span class="sd">                        </span>
</span><span id="CBEM_basic.vectorizeParameters-314"><a href="#CBEM_basic.vectorizeParameters-314"><span class="linenos">314</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.vectorizeParameters-315"><a href="#CBEM_basic.vectorizeParameters-315"><span class="linenos">315</span></a><span class="sd">          B [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk</span>
</span><span id="CBEM_basic.vectorizeParameters-316"><a href="#CBEM_basic.vectorizeParameters-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.vectorizeParameters-317"><a href="#CBEM_basic.vectorizeParameters-317"><span class="linenos">317</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.vectorizeParameters-318"><a href="#CBEM_basic.vectorizeParameters-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="n">B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.vectorizeParameters-319"><a href="#CBEM_basic.vectorizeParameters-319"><span class="linenos">319</span></a>            <span class="n">B_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span>
</span><span id="CBEM_basic.vectorizeParameters-320"><a href="#CBEM_basic.vectorizeParameters-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="n">B_hspk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.vectorizeParameters-321"><a href="#CBEM_basic.vectorizeParameters-321"><span class="linenos">321</span></a>            <span class="n">B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span>
</span><span id="CBEM_basic.vectorizeParameters-322"><a href="#CBEM_basic.vectorizeParameters-322"><span class="linenos">322</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">B_cond</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">B_hspk</span><span class="o">.</span><span class="n">flatten</span><span class="p">()));</span>
</span></pre></div>


            <div class="docstring"><p>Flatens the parameters into a vector for optimization.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B_cond:</strong>    [(P_stim + 1) x 2], if None then self.B_cond -
Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</li>
<li><strong>B_hspk:</strong>    [P_hspk x 1], if None then self.B_hspk -
Parameters of the spike history filter as weights on the basis functions.
The last entry is the basline term.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>B [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.devectorizeParameters" class="classattr">
                                        <input id="CBEM_basic.devectorizeParameters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">devectorizeParameters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.devectorizeParameters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.devectorizeParameters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.devectorizeParameters-324"><a href="#CBEM_basic.devectorizeParameters-324"><span class="linenos">324</span></a>    <span class="k">def</span> <span class="nf">devectorizeParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="CBEM_basic.devectorizeParameters-325"><a href="#CBEM_basic.devectorizeParameters-325"><span class="linenos">325</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.devectorizeParameters-326"><a href="#CBEM_basic.devectorizeParameters-326"><span class="linenos">326</span></a><span class="sd">        Takens in a vector of the parameters and returns them in more convenient separate, matrix forms.</span>
</span><span id="CBEM_basic.devectorizeParameters-327"><a href="#CBEM_basic.devectorizeParameters-327"><span class="linenos">327</span></a>
</span><span id="CBEM_basic.devectorizeParameters-328"><a href="#CBEM_basic.devectorizeParameters-328"><span class="linenos">328</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.devectorizeParameters-329"><a href="#CBEM_basic.devectorizeParameters-329"><span class="linenos">329</span></a><span class="sd">          B:  [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic.devectorizeParameters-330"><a href="#CBEM_basic.devectorizeParameters-330"><span class="linenos">330</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic.devectorizeParameters-331"><a href="#CBEM_basic.devectorizeParameters-331"><span class="linenos">331</span></a><span class="sd">        </span>
</span><span id="CBEM_basic.devectorizeParameters-332"><a href="#CBEM_basic.devectorizeParameters-332"><span class="linenos">332</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.devectorizeParameters-333"><a href="#CBEM_basic.devectorizeParameters-333"><span class="linenos">333</span></a><span class="sd">          A tuple (B_cond, B_hspk)</span>
</span><span id="CBEM_basic.devectorizeParameters-334"><a href="#CBEM_basic.devectorizeParameters-334"><span class="linenos">334</span></a>
</span><span id="CBEM_basic.devectorizeParameters-335"><a href="#CBEM_basic.devectorizeParameters-335"><span class="linenos">335</span></a><span class="sd">            B_cond: [(P_stim + 1) x 2] - </span>
</span><span id="CBEM_basic.devectorizeParameters-336"><a href="#CBEM_basic.devectorizeParameters-336"><span class="linenos">336</span></a><span class="sd">                Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</span>
</span><span id="CBEM_basic.devectorizeParameters-337"><a href="#CBEM_basic.devectorizeParameters-337"><span class="linenos">337</span></a>
</span><span id="CBEM_basic.devectorizeParameters-338"><a href="#CBEM_basic.devectorizeParameters-338"><span class="linenos">338</span></a><span class="sd">            B_hspk:  [P_hspk x 1] - </span>
</span><span id="CBEM_basic.devectorizeParameters-339"><a href="#CBEM_basic.devectorizeParameters-339"><span class="linenos">339</span></a><span class="sd">                Parameters of the spike history filter as weights on the basis functions.</span>
</span><span id="CBEM_basic.devectorizeParameters-340"><a href="#CBEM_basic.devectorizeParameters-340"><span class="linenos">340</span></a><span class="sd">                The last entry is the basline term.</span>
</span><span id="CBEM_basic.devectorizeParameters-341"><a href="#CBEM_basic.devectorizeParameters-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.devectorizeParameters-342"><a href="#CBEM_basic.devectorizeParameters-342"><span class="linenos">342</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.devectorizeParameters-343"><a href="#CBEM_basic.devectorizeParameters-343"><span class="linenos">343</span></a>        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;B is incorrect size: must be a vector containing both conductance and linear terms&quot;</span>
</span><span id="CBEM_basic.devectorizeParameters-344"><a href="#CBEM_basic.devectorizeParameters-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>  <span class="n">B</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span>
</span></pre></div>


            <div class="docstring"><p>Takens in a vector of the parameters and returns them in more convenient separate, matrix forms.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B:</strong>   [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.
This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A tuple (B_cond, B_hspk)</p>
  
  <p>B_cond: [(P_stim + 1) x 2] - 
        Parameters of the two conductance filters as weights on the basis function. First column is excitatory, second inhibitory.</p>
  
  <p>B_hspk:  [P_hspk x 1] - 
        Parameters of the spike history filter as weights on the basis functions.
        The last entry is the basline term.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.setParametersFromVector" class="classattr">
                                        <input id="CBEM_basic.setParametersFromVector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setParametersFromVector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">B</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.setParametersFromVector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.setParametersFromVector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.setParametersFromVector-346"><a href="#CBEM_basic.setParametersFromVector-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">setParametersFromVector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.setParametersFromVector-347"><a href="#CBEM_basic.setParametersFromVector-347"><span class="linenos">347</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.setParametersFromVector-348"><a href="#CBEM_basic.setParametersFromVector-348"><span class="linenos">348</span></a><span class="sd">        Sets the current parameters from a vectorized form.</span>
</span><span id="CBEM_basic.setParametersFromVector-349"><a href="#CBEM_basic.setParametersFromVector-349"><span class="linenos">349</span></a>
</span><span id="CBEM_basic.setParametersFromVector-350"><a href="#CBEM_basic.setParametersFromVector-350"><span class="linenos">350</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.setParametersFromVector-351"><a href="#CBEM_basic.setParametersFromVector-351"><span class="linenos">351</span></a><span class="sd">          B:    [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic.setParametersFromVector-352"><a href="#CBEM_basic.setParametersFromVector-352"><span class="linenos">352</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic.setParametersFromVector-353"><a href="#CBEM_basic.setParametersFromVector-353"><span class="linenos">353</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.setParametersFromVector-354"><a href="#CBEM_basic.setParametersFromVector-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sets the current parameters from a vectorized form.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B:</strong>     [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.
This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</li>
</ul>
</div>


                            </div>
                            <div id="CBEM_basic.vectorizedNegLogLike" class="classattr">
                                        <input id="CBEM_basic.vectorizedNegLogLike-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">vectorizedNegLogLike</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.vectorizedNegLogLike-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.vectorizedNegLogLike"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.vectorizedNegLogLike-359"><a href="#CBEM_basic.vectorizedNegLogLike-359"><span class="linenos">359</span></a>    <span class="k">def</span> <span class="nf">vectorizedNegLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-360"><a href="#CBEM_basic.vectorizedNegLogLike-360"><span class="linenos">360</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-361"><a href="#CBEM_basic.vectorizedNegLogLike-361"><span class="linenos">361</span></a><span class="sd">        Computes the negative log likelihood for the set stimulus and spike train.</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-362"><a href="#CBEM_basic.vectorizedNegLogLike-362"><span class="linenos">362</span></a><span class="sd">        Takes in the parameters in a vectorized form for use with optimizers.</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-363"><a href="#CBEM_basic.vectorizedNegLogLike-363"><span class="linenos">363</span></a>
</span><span id="CBEM_basic.vectorizedNegLogLike-364"><a href="#CBEM_basic.vectorizedNegLogLike-364"><span class="linenos">364</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-365"><a href="#CBEM_basic.vectorizedNegLogLike-365"><span class="linenos">365</span></a><span class="sd">          B:    [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-366"><a href="#CBEM_basic.vectorizedNegLogLike-366"><span class="linenos">366</span></a><span class="sd">                This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-367"><a href="#CBEM_basic.vectorizedNegLogLike-367"><span class="linenos">367</span></a>
</span><span id="CBEM_basic.vectorizedNegLogLike-368"><a href="#CBEM_basic.vectorizedNegLogLike-368"><span class="linenos">368</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-369"><a href="#CBEM_basic.vectorizedNegLogLike-369"><span class="linenos">369</span></a><span class="sd">          nll [1] - The total negative log likelihood for the setup stimulus.</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-370"><a href="#CBEM_basic.vectorizedNegLogLike-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-371"><a href="#CBEM_basic.vectorizedNegLogLike-371"><span class="linenos">371</span></a>        <span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="CBEM_basic.vectorizedNegLogLike-372"><a href="#CBEM_basic.vectorizedNegLogLike-372"><span class="linenos">372</span></a>        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogLike</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">());</span>
</span></pre></div>


            <div class="docstring"><p>Computes the negative log likelihood for the set stimulus and spike train.
Takes in the parameters in a vectorized form for use with optimizers.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B:</strong>     [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.
This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>nll [1] - The total negative log likelihood for the setup stimulus.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.vectorizedPenalizedNegLogLike" class="classattr">
                                        <input id="CBEM_basic.vectorizedPenalizedNegLogLike-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">vectorizedPenalizedNegLogLike</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">B</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">conductance_penalty</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.vectorizedPenalizedNegLogLike-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.vectorizedPenalizedNegLogLike"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-374"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-374"><span class="linenos">374</span></a>    <span class="k">def</span> <span class="nf">vectorizedPenalizedNegLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">conductance_penalty</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-375"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-375"><span class="linenos">375</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-376"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-376"><span class="linenos">376</span></a><span class="sd">        Computes the penalized negative log likelihood for the set stimulus and spike train.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-377"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-377"><span class="linenos">377</span></a><span class="sd">        Takes in the parameters in a vectorized form for use with optimizers.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-378"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-378"><span class="linenos">378</span></a><span class="sd">        The penalty terms are the weighted squared norms of the conductance filters.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-379"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-379"><span class="linenos">379</span></a><span class="sd">        </span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-380"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-380"><span class="linenos">380</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-381"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-381"><span class="linenos">381</span></a><span class="sd">          B: [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-382"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-382"><span class="linenos">382</span></a><span class="sd">                    This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-383"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-383"><span class="linenos">383</span></a><span class="sd">          conductance_penalty:  [2] -</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-384"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-384"><span class="linenos">384</span></a><span class="sd">                    The weights of the penalty on the squared norms of the filter weights.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-385"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-385"><span class="linenos">385</span></a><span class="sd">                    The first term is for the excitatory and the second for the inhibitory.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-386"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-386"><span class="linenos">386</span></a><span class="sd">                    The baseline conductance terms do not contribute to this penalty.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-387"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-387"><span class="linenos">387</span></a>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-388"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-388"><span class="linenos">388</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-389"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-389"><span class="linenos">389</span></a><span class="sd">          nll [1] - The total negative log likelihood for the setup stimulus plus the penalties.</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-390"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-390"><span class="linenos">390</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-391"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-391"><span class="linenos">391</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-392"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-392"><span class="linenos">392</span></a>        <span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devectorizeParameters</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-393"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-393"><span class="linenos">393</span></a>        <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogLike</span><span class="p">(</span><span class="n">B_cond</span><span class="p">,</span> <span class="n">B_hspk</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">());</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-394"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-394"><span class="linenos">394</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-395"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-395"><span class="linenos">395</span></a>            <span class="n">nll</span> <span class="o">+=</span> <span class="n">conductance_penalty</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">);</span>
</span><span id="CBEM_basic.vectorizedPenalizedNegLogLike-396"><a href="#CBEM_basic.vectorizedPenalizedNegLogLike-396"><span class="linenos">396</span></a>        <span class="k">return</span> <span class="n">nll</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>Computes the penalized negative log likelihood for the set stimulus and spike train.
Takes in the parameters in a vectorized form for use with optimizers.
The penalty terms are the weighted squared norms of the conductance filters.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>B:</strong>  [(P_stim + 1) * 2 + P_hspk] - Flattened B_cond and B_hspk.
This should correspond to concatenate((B_cond.flatten(), B_hspk.flatten))</li>
<li><strong>conductance_penalty:</strong>   [2] -
The weights of the penalty on the squared norms of the filter weights.
The first term is for the excitatory and the second for the inhibitory.
The baseline conductance terms do not contribute to this penalty.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>nll [1] - The total negative log likelihood for the setup stimulus plus the penalties.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.getConductanceFilter" class="classattr">
                                        <input id="CBEM_basic.getConductanceFilter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getConductanceFilter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cc</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getConductanceFilter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getConductanceFilter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getConductanceFilter-398"><a href="#CBEM_basic.getConductanceFilter-398"><span class="linenos">398</span></a>    <span class="k">def</span> <span class="nf">getConductanceFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getConductanceFilter-399"><a href="#CBEM_basic.getConductanceFilter-399"><span class="linenos">399</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getConductanceFilter-400"><a href="#CBEM_basic.getConductanceFilter-400"><span class="linenos">400</span></a><span class="sd">        Gets the full conductance filter (basis times weights) for one of the conductance filters.</span>
</span><span id="CBEM_basic.getConductanceFilter-401"><a href="#CBEM_basic.getConductanceFilter-401"><span class="linenos">401</span></a>
</span><span id="CBEM_basic.getConductanceFilter-402"><a href="#CBEM_basic.getConductanceFilter-402"><span class="linenos">402</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.getConductanceFilter-403"><a href="#CBEM_basic.getConductanceFilter-403"><span class="linenos">403</span></a><span class="sd">          cc: Index of the conductance filter to return. 0 is excitatory, 1 is inhibitory.</span>
</span><span id="CBEM_basic.getConductanceFilter-404"><a href="#CBEM_basic.getConductanceFilter-404"><span class="linenos">404</span></a>
</span><span id="CBEM_basic.getConductanceFilter-405"><a href="#CBEM_basic.getConductanceFilter-405"><span class="linenos">405</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.getConductanceFilter-406"><a href="#CBEM_basic.getConductanceFilter-406"><span class="linenos">406</span></a><span class="sd">          k_stim [BT_stim x N_pixels] - The filter for each pixel.</span>
</span><span id="CBEM_basic.getConductanceFilter-407"><a href="#CBEM_basic.getConductanceFilter-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getConductanceFilter-408"><a href="#CBEM_basic.getConductanceFilter-408"><span class="linenos">408</span></a>
</span><span id="CBEM_basic.getConductanceFilter-409"><a href="#CBEM_basic.getConductanceFilter-409"><span class="linenos">409</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.getConductanceFilter-410"><a href="#CBEM_basic.getConductanceFilter-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span> <span class="o">@</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">cc</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_pixels</span><span class="p">));</span>
</span></pre></div>


            <div class="docstring"><p>Gets the full conductance filter (basis times weights) for one of the conductance filters.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>cc:</strong>  Index of the conductance filter to return. 0 is excitatory, 1 is inhibitory.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>k_stim [BT_stim x N_pixels] - The filter for each pixel.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.getSpikeHistoryFilter" class="classattr">
                                        <input id="CBEM_basic.getSpikeHistoryFilter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getSpikeHistoryFilter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.getSpikeHistoryFilter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.getSpikeHistoryFilter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.getSpikeHistoryFilter-412"><a href="#CBEM_basic.getSpikeHistoryFilter-412"><span class="linenos">412</span></a>    <span class="k">def</span> <span class="nf">getSpikeHistoryFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-413"><a href="#CBEM_basic.getSpikeHistoryFilter-413"><span class="linenos">413</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-414"><a href="#CBEM_basic.getSpikeHistoryFilter-414"><span class="linenos">414</span></a><span class="sd">        Gets the full spike history filter (basis times weights).</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-415"><a href="#CBEM_basic.getSpikeHistoryFilter-415"><span class="linenos">415</span></a>
</span><span id="CBEM_basic.getSpikeHistoryFilter-416"><a href="#CBEM_basic.getSpikeHistoryFilter-416"><span class="linenos">416</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-417"><a href="#CBEM_basic.getSpikeHistoryFilter-417"><span class="linenos">417</span></a><span class="sd">          h_spk [BT_hspk x 1] - The full spike history filter.</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-418"><a href="#CBEM_basic.getSpikeHistoryFilter-418"><span class="linenos">418</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-419"><a href="#CBEM_basic.getSpikeHistoryFilter-419"><span class="linenos">419</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.getSpikeHistoryFilter-420"><a href="#CBEM_basic.getSpikeHistoryFilter-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_hspk</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>Gets the full spike history filter (basis times weights).</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>h_spk [BT_hspk x 1] - The full spike history filter.</p>
</blockquote>
</div>


                            </div>
                            <div id="CBEM_basic.simulateSpikeTrains" class="classattr">
                                        <input id="CBEM_basic.simulateSpikeTrains-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">simulateSpikeTrains</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">Y_init</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="CBEM_basic.simulateSpikeTrains-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CBEM_basic.simulateSpikeTrains"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CBEM_basic.simulateSpikeTrains-423"><a href="#CBEM_basic.simulateSpikeTrains-423"><span class="linenos">423</span></a>    <span class="k">def</span> <span class="nf">simulateSpikeTrains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y_init</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">N</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="CBEM_basic.simulateSpikeTrains-424"><a href="#CBEM_basic.simulateSpikeTrains-424"><span class="linenos">424</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CBEM_basic.simulateSpikeTrains-425"><a href="#CBEM_basic.simulateSpikeTrains-425"><span class="linenos">425</span></a><span class="sd">        Simulates a set of spike trains with the currently set stimulus. This can be really slow!</span>
</span><span id="CBEM_basic.simulateSpikeTrains-426"><a href="#CBEM_basic.simulateSpikeTrains-426"><span class="linenos">426</span></a><span class="sd">        This function requires an initial set of spikes to avoid dealing with edge effects of the spike history filter.</span>
</span><span id="CBEM_basic.simulateSpikeTrains-427"><a href="#CBEM_basic.simulateSpikeTrains-427"><span class="linenos">427</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-428"><a href="#CBEM_basic.simulateSpikeTrains-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="CBEM_basic.simulateSpikeTrains-429"><a href="#CBEM_basic.simulateSpikeTrains-429"><span class="linenos">429</span></a><span class="sd">          Y_init:  [T_0 x (N or 1)] - A matrix of ones and zerosThe initial spike trains. T_0 should be less than T_stim</span>
</span><span id="CBEM_basic.simulateSpikeTrains-430"><a href="#CBEM_basic.simulateSpikeTrains-430"><span class="linenos">430</span></a><span class="sd">          N:       (positive integer) - The number of simulations: only use this if Y_init.shape[1] == 1 and you want more than one simulation.</span>
</span><span id="CBEM_basic.simulateSpikeTrains-431"><a href="#CBEM_basic.simulateSpikeTrains-431"><span class="linenos">431</span></a><span class="sd">                                             If N &gt; 1 and Y_init.shape[1] == 1, it uses the same initial spike train for all simulations.</span>
</span><span id="CBEM_basic.simulateSpikeTrains-432"><a href="#CBEM_basic.simulateSpikeTrains-432"><span class="linenos">432</span></a><span class="sd">                                                                 </span>
</span><span id="CBEM_basic.simulateSpikeTrains-433"><a href="#CBEM_basic.simulateSpikeTrains-433"><span class="linenos">433</span></a><span class="sd">        Returns:</span>
</span><span id="CBEM_basic.simulateSpikeTrains-434"><a href="#CBEM_basic.simulateSpikeTrains-434"><span class="linenos">434</span></a><span class="sd">          sps [T_stim x N] - A matrix of spikes for each of the N simulations. Spikes are either 1 or 0.</span>
</span><span id="CBEM_basic.simulateSpikeTrains-435"><a href="#CBEM_basic.simulateSpikeTrains-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CBEM_basic.simulateSpikeTrains-436"><a href="#CBEM_basic.simulateSpikeTrains-436"><span class="linenos">436</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model filters not initialized&quot;</span>
</span><span id="CBEM_basic.simulateSpikeTrains-437"><a href="#CBEM_basic.simulateSpikeTrains-437"><span class="linenos">437</span></a>        <span class="n">Y_init</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-438"><a href="#CBEM_basic.simulateSpikeTrains-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CBEM_basic.simulateSpikeTrains-439"><a href="#CBEM_basic.simulateSpikeTrains-439"><span class="linenos">439</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="CBEM_basic.simulateSpikeTrains-440"><a href="#CBEM_basic.simulateSpikeTrains-440"><span class="linenos">440</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Invalid arguments for number of simulations&quot;</span>
</span><span id="CBEM_basic.simulateSpikeTrains-441"><a href="#CBEM_basic.simulateSpikeTrains-441"><span class="linenos">441</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-442"><a href="#CBEM_basic.simulateSpikeTrains-442"><span class="linenos">442</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_cond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># total simulation length</span>
</span><span id="CBEM_basic.simulateSpikeTrains-443"><a href="#CBEM_basic.simulateSpikeTrains-443"><span class="linenos">443</span></a>        <span class="n">T_0</span> <span class="o">=</span> <span class="n">Y_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># initial seed length</span>
</span><span id="CBEM_basic.simulateSpikeTrains-444"><a href="#CBEM_basic.simulateSpikeTrains-444"><span class="linenos">444</span></a>        <span class="n">P_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_hspk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="CBEM_basic.simulateSpikeTrains-445"><a href="#CBEM_basic.simulateSpikeTrains-445"><span class="linenos">445</span></a>        <span class="k">assert</span> <span class="n">T_0</span> <span class="o">&gt;</span> <span class="n">P_lin</span> <span class="ow">and</span> <span class="n">T_0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_conductance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;initial spike train too short for bases&quot;</span>
</span><span id="CBEM_basic.simulateSpikeTrains-446"><a href="#CBEM_basic.simulateSpikeTrains-446"><span class="linenos">446</span></a>        <span class="k">assert</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no simulations requested&quot;</span>
</span><span id="CBEM_basic.simulateSpikeTrains-447"><a href="#CBEM_basic.simulateSpikeTrains-447"><span class="linenos">447</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-448"><a href="#CBEM_basic.simulateSpikeTrains-448"><span class="linenos">448</span></a>        <span class="c1"># sets up spikes</span>
</span><span id="CBEM_basic.simulateSpikeTrains-449"><a href="#CBEM_basic.simulateSpikeTrains-449"><span class="linenos">449</span></a>        <span class="n">sps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-450"><a href="#CBEM_basic.simulateSpikeTrains-450"><span class="linenos">450</span></a>        <span class="n">sps</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">at</span><span class="p">[:</span><span class="n">T_0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Y_init</span><span class="p">);</span>
</span><span id="CBEM_basic.simulateSpikeTrains-451"><a href="#CBEM_basic.simulateSpikeTrains-451"><span class="linenos">451</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-452"><a href="#CBEM_basic.simulateSpikeTrains-452"><span class="linenos">452</span></a>        <span class="c1"># gets voltage (in this model, it&#39;s determined by the stimulus. Would need a more complex function for spike-dependent conductances)</span>
</span><span id="CBEM_basic.simulateSpikeTrains-453"><a href="#CBEM_basic.simulateSpikeTrains-453"><span class="linenos">453</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">();</span>
</span><span id="CBEM_basic.simulateSpikeTrains-454"><a href="#CBEM_basic.simulateSpikeTrains-454"><span class="linenos">454</span></a>        <span class="n">h_spk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSpikeHistoryFilter</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-455"><a href="#CBEM_basic.simulateSpikeTrains-455"><span class="linenos">455</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-456"><a href="#CBEM_basic.simulateSpikeTrains-456"><span class="linenos">456</span></a>        <span class="c1"># random values for spike generation</span>
</span><span id="CBEM_basic.simulateSpikeTrains-457"><a href="#CBEM_basic.simulateSpikeTrains-457"><span class="linenos">457</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="CBEM_basic.simulateSpikeTrains-458"><a href="#CBEM_basic.simulateSpikeTrains-458"><span class="linenos">458</span></a>        <span class="n">rs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-459"><a href="#CBEM_basic.simulateSpikeTrains-459"><span class="linenos">459</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-460"><a href="#CBEM_basic.simulateSpikeTrains-460"><span class="linenos">460</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; simulations... (WARNING: This function can be painfully slow!)&quot;</span><span class="p">);</span>
</span><span id="CBEM_basic.simulateSpikeTrains-461"><a href="#CBEM_basic.simulateSpikeTrains-461"><span class="linenos">461</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_0 = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T_0</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-462"><a href="#CBEM_basic.simulateSpikeTrains-462"><span class="linenos">462</span></a>        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T_0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
</span><span id="CBEM_basic.simulateSpikeTrains-463"><a href="#CBEM_basic.simulateSpikeTrains-463"><span class="linenos">463</span></a>            <span class="k">if</span> <span class="n">tt</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CBEM_basic.simulateSpikeTrains-464"><a href="#CBEM_basic.simulateSpikeTrains-464"><span class="linenos">464</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tt = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; / &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-465"><a href="#CBEM_basic.simulateSpikeTrains-465"><span class="linenos">465</span></a>            <span class="c1"># gets spike history &amp; adds to voltage</span>
</span><span id="CBEM_basic.simulateSpikeTrains-466"><a href="#CBEM_basic.simulateSpikeTrains-466"><span class="linenos">466</span></a>            <span class="n">V_c</span> <span class="o">=</span> <span class="n">h_spk</span> <span class="o">@</span> <span class="n">sps</span><span class="p">[(</span><span class="n">tt</span><span class="o">-</span><span class="n">P_lin</span><span class="p">):</span><span class="n">tt</span><span class="p">,:];</span>
</span><span id="CBEM_basic.simulateSpikeTrains-467"><a href="#CBEM_basic.simulateSpikeTrains-467"><span class="linenos">467</span></a>            <span class="n">V_c</span> <span class="o">+=</span> <span class="n">V</span><span class="p">[</span><span class="n">tt</span><span class="p">];</span>
</span><span id="CBEM_basic.simulateSpikeTrains-468"><a href="#CBEM_basic.simulateSpikeTrains-468"><span class="linenos">468</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-469"><a href="#CBEM_basic.simulateSpikeTrains-469"><span class="linenos">469</span></a>            <span class="c1"># gets spike probability</span>
</span><span id="CBEM_basic.simulateSpikeTrains-470"><a href="#CBEM_basic.simulateSpikeTrains-470"><span class="linenos">470</span></a>            <span class="n">fr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binSize_ms</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">firingRateNonlinearity</span><span class="p">(</span><span class="n">V_c</span><span class="p">);</span>
</span><span id="CBEM_basic.simulateSpikeTrains-471"><a href="#CBEM_basic.simulateSpikeTrains-471"><span class="linenos">471</span></a>            <span class="n">p_1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fr</span><span class="p">));</span>
</span><span id="CBEM_basic.simulateSpikeTrains-472"><a href="#CBEM_basic.simulateSpikeTrains-472"><span class="linenos">472</span></a>            <span class="n">spiked</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="n">p_1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">();</span>
</span><span id="CBEM_basic.simulateSpikeTrains-473"><a href="#CBEM_basic.simulateSpikeTrains-473"><span class="linenos">473</span></a>
</span><span id="CBEM_basic.simulateSpikeTrains-474"><a href="#CBEM_basic.simulateSpikeTrains-474"><span class="linenos">474</span></a>            <span class="c1"># generates spike</span>
</span><span id="CBEM_basic.simulateSpikeTrains-475"><a href="#CBEM_basic.simulateSpikeTrains-475"><span class="linenos">475</span></a>            <span class="n">sps</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">spiked</span><span class="p">);</span>
</span><span id="CBEM_basic.simulateSpikeTrains-476"><a href="#CBEM_basic.simulateSpikeTrains-476"><span class="linenos">476</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">);</span>
</span><span id="CBEM_basic.simulateSpikeTrains-477"><a href="#CBEM_basic.simulateSpikeTrains-477"><span class="linenos">477</span></a>        <span class="k">return</span> <span class="n">sps</span><span class="p">;</span>
</span></pre></div>


            <div class="docstring"><p>Simulates a set of spike trains with the currently set stimulus. This can be really slow!
This function requires an initial set of spikes to avoid dealing with edge effects of the spike history filter.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>Y_init:</strong>   [T_0 x (N or 1)] - A matrix of ones and zerosThe initial spike trains. T_0 should be less than T_stim</li>
<li><strong>N:</strong>        (positive integer) - The number of simulations: only use this if Y_init.shape[1] == 1 and you want more than one simulation.
If N &gt; 1 and Y_init.shape[1] == 1, it uses the same initial spike train for all simulations.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>sps [T_stim x N] - A matrix of spikes for each of the N simulations. Spikes are either 1 or 0.</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>